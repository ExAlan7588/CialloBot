@EXIST_FreeAct8
#LOCALSIZE 1
#LOCALSSIZE 1

;オブジェクト本体
@FreeAct8(ARG, O_DATA, V_NAME)
#FUNCTION
#LOCALSIZE 1
#LOCALSSIZE 1
#DIMS O_DATA
#DIMS V_NAME
#DIM 经过时间
经过时间 = Activity_Duration:TARGET
SELECTCASE O_DATA
;陪同行动指令の名称
CASE "名称"
	IF TALENT:ARG:音乐知识 == 1
		CALLF MAKE_STR(V_NAME, "协同合奏")
	ELSE
		CALLF MAKE_STR(V_NAME, "进行伴奏")
	ENDIF
CASE "CHAIN"
;他角色に连锁しない场合コメントアウトすること
	CALLF MAKE_INT(V_NAME, 1)
CASE "经过时间"
;陪同行动指令での经过时间
;0だと30分か残り时间全部の小さい方
	CALLF MAKE_INT(V_NAME, 0)
ENDSELECT

@自由行动内容_8(CHARA, ARGS, 时间系数, CHAIN)
#DIM CHARA
#DIM CHAIN
#DIM 现在地
#DIM メッセージ表示
#DIM 时间系数
#DIM 经过时间
现在地 = CFLAG:CHARA:当前位置
メッセージ表示 = 现在地 == CFLAG:MASTER:当前位置 ? 1 # 0
SELECTCASE ARGS
	CASE "发生"
		;［音乐知识］持ちの角色が训练できる场所にいる时
		SIF !TALENT:CHARA:音乐知识
			RETURN 0
		SIF !战斗训练可(现在地)
			RETURN 0
		SIF BASE:CHARA:气力 <= MAXBASE:CHARA:气力 / 2
			RETURN 0
		IF メッセージ表示
			IF CHAIN
				SELECTCASE TALENT:CHAIN:音乐知识
				CASE 1
					SELECTCASE TALENT:CHARA:音乐知识
					CASE 1
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%开始和%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%一起合奏了。
					CASE 2
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%的演奏开始唱歌了。
					CASE 3
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%的演奏开始跳舞了。
					ENDSELECT
				CASE 2
					SELECTCASE TALENT:CHARA:音乐知识
					CASE 1
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%的歌声开始演奏起来了
					CASE 2
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%担任起%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%的和声了。
					CASE 3
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%的歌声开始跳舞了。
					ENDSELECT
				CASE 3
					SELECTCASE TALENT:CHARA:音乐知识
					CASE 1
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%的舞蹈开始演奏了。
					CASE 2
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%的舞蹈开始唱歌了。
					CASE 3
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%和%NAME_OUTPUT_TRANSLATION("CALLNAME", CHAIN)%一起跳起舞来。
					ENDSELECT
				ENDSELECT
			ELSE
				SELECTCASE TALENT:CHARA:音乐知识
				CASE 1
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%缓缓地开始演奏起来。
				CASE 2
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%情不自禁地开始唱起歌来。
				CASE 3
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%飘飘然地开始跳起舞来。
				ENDSELECT
			ENDIF
		ENDIF
		RETURN 60 + RAND:30
	CASE "行动中"
		IF メッセージ表示
			SELECTCASE TALENT:CHARA:音乐知识
			CASE 1
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%在畅快地演奏着。
			CASE 2
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%在自由自在地歌唱着。
			CASE 3
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%在华丽地舞蹈着。
			ENDSELECT
		ENDIF
	CASE "完了"
		SELECTCASE TALENT:CHARA:音乐知识
		CASE 1
			EXP:CHARA:演奏经验 += 1
			SIF メッセージ表示
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%结束了演奏后缓了缓气。
		CASE 2
			EXP:CHARA:歌唱经验 += 1
			SIF メッセージ表示
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%结束了歌唱后缓了缓气。
		CASE 3
			EXP:CHARA:舞蹈经验 += 1
			SIF メッセージ表示
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%结束了舞蹈后缓了口气。
		ENDSELECT
	CASE "中断"
		SELECTCASE TALENT:CHARA:音乐知识
		CASE 1
			EXP:CHARA:演奏经验 += 1
		CASE 2
			EXP:CHARA:歌唱经验 += 1
		CASE 3
			EXP:CHARA:舞蹈经验 += 1
		ENDSELECT
	CASE "行动中"
		;行动中の处理、地の文もここで
		IF 充填率(TARGET,1) >= 10 || 充填率(TARGET,2) >= 10
				SIF メッセージ表示
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%红着脸%TEXTR("在呼吸/在闪烁/在做鬼脸")%。
			ELSE
				SIF メッセージ表示
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%%TEXTR("在呼吸/在闪烁/在做鬼脸")%。
			ENDIF
	CASE "完了"
		;行动时间を使い切ったときの处理、地の文もここで
		IF 充填率(CHARA,1) >= 10 || 充填率(CHARA,2) >= 10
			SIF メッセージ表示
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%活动结束后吐着甜美的喘息。
		ELSE
			SIF メッセージ表示
				PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", CHARA)%的活动结束了。
		ENDIF	
		
	CASE "中断"
		;中断したときの处理、地の文もここで
	CASE "交手"
		IF TFLAG:193 == -2
			SELECTCASE TALENT:TARGET:音乐知识
			CASE 1
				PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%因为没有可以用的乐器、只好呆呆地听着%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的演奏…
			CASE 2
				PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%因为没有可以用的乐器、只好呆呆地听着%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的演唱…
			CASE 3
				PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%因为没有可以用的乐器、只好呆呆地看着%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的舞蹈…
			ENDSELECT
		ELSE
			SELECTCASE TALENT:TARGET:音乐知识
			CASE 1
				PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%和%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%并列在一起合奏起来
				IF TFLAG:193 > 0
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%兴致勃勃地演奏着…
				ELSEIF TFLAG:193 < 0
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%露出了紧张的神色…
				ELSE
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%发挥稳定地得演奏着…
				ENDIF
			CASE 2
				PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的歌声开始演奏起来
				IF TFLAG:193 > 0
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%兴致勃勃地演唱着…
				ELSEIF TFLAG:193 < 0
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%露出了紧张的神色…
				ELSE
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%发挥稳定地演唱着…
				ENDIF
			CASE 3
				PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%配合着%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的舞蹈开始演奏起来
				IF TFLAG:193 > 0
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%兴致勃勃地跳着舞…
				ELSEIF TFLAG:193 < 0
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%露出了紧张的神色…
				ELSE
					PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%发挥稳定地跳着舞…
				ENDIF
			ENDSELECT
		ENDIF
	CASE "ソース"
		IF !GROUPMATCH(1, MUSIC_ABLE(30), MUSIC_ABLE(31), MUSIC_ABLE(32), MUSIC_ABLE(33), MUSIC_ABLE(34), MUSIC_ABLE(35))
			;乐器が使えないと见てるだけ
			TFLAG:193 = -2
			DOWNBASE:MASTER:气力 += 20 * 时间系数
			DOWNBASE:TARGET:体力 += 10 * 时间系数
			DOWNBASE:TARGET:气力 += 20 * 时间系数
			SOURCE:欢乐 = (50 + ((ABL:亲密 + ABL:MASTER:音乐技能) * 10)) * 时间系数
		ELSE
			DOWNBASE:MASTER:体力 += 40 * 时间系数
			DOWNBASE:MASTER:气力 += 40 * 时间系数
			DOWNBASE:TARGET:体力 += 20 * 时间系数
			DOWNBASE:TARGET:气力 += 20 * 时间系数
			SELECTCASE RAND:(10 + ABL:MASTER:音乐技能)
			CASE 0
				;失败
				TFLAG:193 = -1
				SOURCE:欢乐 = (100 + ((ABL:亲密 + ABL:MASTER:音乐技能) * 20)) * 时间系数
			CASE 1 TO 9
				;成功
				SOURCE:欢乐 = (150 + ((ABL:亲密 + ABL:MASTER:音乐技能) * 50)) * 时间系数
				TFLAG:98 = 1
			CASEELSE
				;音乐技能があるとその概率で大成功
				TFLAG:193 = 1
				SOURCE:欢乐 = (200 + ((ABL:亲密 + ABL:MASTER:音乐技能) * 80)) * 时间系数
				TFLAG:98 = 2
			ENDSELECT
			;その场にいる他の角色にもソースが入る
			FOR LOCAL, 1, GET_TARGETNUM() + 1
				SIF TARGET:LOCAL == TARGET
					CONTINUE
				SIF !SHIRAHU(TARGET:LOCAL)
					CONTINUE
				SOURCE:(TARGET:LOCAL):欢乐 = ((150 + (50 * TFLAG:193)) + ((ABL:(TARGET:LOCAL):亲密 + ABL:MASTER:音乐技能) * (50 + (30 * TFLAG:193)))) * 时间系数
			NEXT
			EXP:MASTER:演奏经验 ++
		ENDIF
ENDSELECT