@GO_OUT_CONDITION_EV1
RESULT = 0
;约会中は发生しない
SIF RAND:3 || FLAG:约会的对象
	RETURN 0
;その日物色済みだと无理
SIF GETBIT(TFLAG:一日一回, 9)
	RETURN 0
IF WEATHERDLC
	IF TIME:5 != 3
		SIF RAND:100 > 50
			RETURN 0
	ELSEIF RAND:100 > 75
			RETURN 0
	ENDIF
ELSE
ENDIF
IF ENCOUNTDLC
	SIF SUMIPROTECT
		PRINTFORMW 在路上，突然感觉到了被袭击的预感，%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%不由得在心中感谢了堇子的加护，连忙小心的躲避了开来……
		RETURN 0
ENDIF
CALL GO_OUT_EV1
RETURN RESULT

@GO_OUT_EV1
#DIM ENEMY
#DIMS ENEMY_RACE
#DIM モブ残机
#DIM LOOT
#DIM LOOT_CANDIDATE, 17 = 51, 52, 53, 55, 56, 58, 59, 81, 82, 83, 84, 121, 131, 500, 501, 502, 510
#DIM CONST CANDIDATE_N = 17
#DIM REWARD
#DIM 发情フラグ
#DIM 满月バフ效果
发情フラグ = 0
满月バフ效果 = 0
;相手が变わるとかやりたい
SELECTCASE CFLAG:MASTER:约会中
	;湖
	CASE 3
		ENEMY_RACE = 妖精
	;竹林
	CASE 4
		IF !RAND:3
			ENEMY_RACE = 因幡
		ELSE
			ENEMY_RACE = 妖精
		ENDIF
	;魔法之森
	CASE 5
		ENEMY_RACE '= TEXTR("妖怪狸/茨狸")
	;三途之川
	CASE 6
		ENEMY_RACE '= TEXTR("妖怪狐/妖怪猫")
	;山麓
	CASE 7
		ENEMY_RACE = 河童
	;山顶
	CASE 8
		ENEMY_RACE = 白狼天狗
	;地底
	CASE 9
		ENEMY_RACE = 鬼
	;月
	CASE 10
		ENEMY_RACE = 玉兔
	CASEELSE
		RETURN 0
ENDSELECT

PRINTFORMW 回来的路上、突然被%ENEMY_RACE%袭击了！
SETBIT TFLAG:一日一回, 9
;桃色の风による影响
IF (FLAG:异常气象 == 8 && TCVAR:RANDOM_CHARANUM:发情) || TCVAR:RANDOM_CHARANUM:祈愿桃色の风
	发情フラグ = 1
ENDIF
CALL MAKE_YUKIZURI(RANDOM_CHARANUM, ENEMY_RACE, 1)
ENEMY = RANDOM_CHARANUM
;BUG 防止出现“### MOVEMENT LOCATION ERROR %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)% 的当前位置异常 ### CHARA_NO:{LOCAL}”报错提示
CFLAG:RANDOM_CHARANUM:约会中 = CFLAG:MASTER:约会中

;满月时
IF TALENT:ENEMY:动物耳 && MOON_WATCH(DAY:3) == 9
	发情フラグ = 2
	CALL COLORMESSAGE(@"满月的光芒激起了%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%的本能…！",C_YELLOW,1)
	CALL COLORMESSAGE(@"%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%的战斗力提升！",C_YELLOW,1)
	满月バフ效果 = 1 + RAND:(MAX(2, ABL:MASTER:战斗能力 - ABL:ENEMY:战斗能力))
	ABL:ENEMY:战斗能力 += 满月バフ效果
ENDIF
IF 发情フラグ
	TCVAR:ENEMY:发情 = 1
	CFLAG:ENEMY:积攒度 += LIMIT((10 + RAND:20 + RAND:20 + RAND:20) * ABL:ENEMY:欲望,200,1000)
	
	IF 发情フラグ == 2
		;满月时は危险日确定
		CFLAG:ENEMY:900 = 7
	ELSE
		SELECTCASE FLAG:抱负
			CASE 6
				;抱负が子孙繁栄で未达成の场合は危险日确定
				CFLAG:ENEMY:900 = 7
			CASE 9
				;子孙繁栄达成済み、かつ、安全日の场合は再设定
				SIF ESTRUS_CYCLE(ENEMY) <= 15
					CFLAG:ENEMY:900 = RAND:10
		ENDSELECT
	ENDIF
ENDIF

HANDICAP_FIXED = RAND:(ABL:ENEMY:战斗能力 * 5 + 1) + 10
HANDICAP_RAND = 0

CALL KOJO_MESSAGE_SEND("DANMAKU", 0, ENEMY, 1, -1, "战斗前")
TEQUIP:ENEMY:上半身着衣状况 = 1

CALL CHARA_STATE(ENEMY)
	DRAWLINE
	CALL COLORMESSAGE(@"处女丧失履历：%CSTR:ENEMY:处女丧失履历%",C_PINK,1)
	PRINTFORML 
CALL DANMAKU_OPPONENT_STATUS(ENEMY)
IF HANDICAP_FIXED
	CALL COLORMESSAGE(@"地形效果：%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的骰子值降低{HANDICAP_FIXED}",C_YELLOW,1)
	;【三粒の天滴】の效果
	IF ITEM:三粒の天滴
		HANDICAP_FIXED /= 2
		CALL COLORMESSAGE(@"因为土着神的诅咒、地形效果半减为{HANDICAP_FIXED}！",C_YELLOW,1)
	ENDIF
ENDIF
$LOOP
CALL ASK_M("回头一击",1,"逃跑",1,"规则说明",1)
SELECTCASE RESULT
	CASE 0
		IF BASE:MASTER:气力 < 1000 || BASE:MASTER:体力 < 1000
			PRINTFORML 现在因为疲劳战力会下降，即使这样也要战斗吗？
			CALL ASK_YN()
			IF RESULT == 0
				HANDICAP_FIXED += MAX(0, 1000 - BASE:MASTER:气力)
				HANDICAP_FIXED += MAX(0, 1000 - BASE:MASTER:体力)
				CALL COLORMESSAGE(@"由于疲劳，%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的骰子值降低了{HANDICAP_FIXED}",C_YELLOW,1)
			ELSE
				PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%一溜烟地逃走了
				RETURN 1
		ENDIF
		ENDIF
	CASE 1
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%迅捷地逃走了
		RETURN 1
	CASE 2
		CALL SHOW_DANMAKU_RULE
		GOTO LOOP
ENDSELECT
TARGET = ENEMY
REWARD = MAX(ABL:ENEMY:战斗能力 * 10 + RAND:5, 1)
;米とか酒とか
LOOT = LOOT_CANDIDATE:(RAND:CANDIDATE_N)
TIME += 60
CFLAG:ENEMY:认识 = 1
PRINTFORMW 胜负开始！！
CALL DANMAKU_BATTLE(TARGET, 1)

モブ残机 = RESULT
CALL RECOVER(MASTER, -500, "体力")
CALL RECOVER(MASTER, -500, "气力")
CALL KOJO_MESSAGE_SEND("DANMAKU", モブ残机, TARGET, 1, -1, "战斗后")
SIF モブ残机 < 3
	EXP:MASTER:战斗经验 += ABL:ENEMY:战斗能力 * 3
SIF モブ残机 < 1
	EXP:MASTER:战斗经验 += ABL:ENEMY:战斗能力
ABL:ENEMY:战斗能力 -= 满月バフ效果
IF モブ残机 > 0
	;モブ娘胜利（MASTERの败战）处理
	SETCOLOR C_RED
	IF TCVAR:ENEMY:发情 && HAS_PENIS(MASTER)
		;CALL KOJO_MESSAGE_SEND("DANMAKU", モブ残机, TARGET, 1, -1, "逆レ开始")
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%压在了动不了的%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%身上
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的喉咙上、温暖的吐息吹了上来…
		PRINTFORML 还没有想明白是怎么回事的下一瞬间、性器被温热的感触包裹住了
		PRINTFORML 战战兢兢地往下腹部一看、是狡猾地笑着的%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%的小穴把%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的阴茎吞到了最根部
		IF 发情フラグ == 1
			PRINTFORM 受到桃色的风影响，
		ELSEIF 发情フラグ == 2
			PRINTFORM 满月之夜迎来发情期的
		ENDIF
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%为了消解兽性的渇望、把%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%按在身下肆意地侵犯着、蹂躏着、使用着…
		PRINTFORMW ………
		PRINTFORMW ……
		PRINTFORMW …
		PRINTFORMW 一直到满足为止、把%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%吃干抹净的%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%丢下%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%离开了
		FLAG:气绝中断 = 100 + CFLAG:MASTER:当前位置 / 100
		CFLAG:MASTER:约会中 = CFLAG:MASTER:当前位置 / 100
		CALL LOST_GYAKURE(ENEMY)
	ELSEIF ITEM:LOOT
		PRINTFORMW 输掉的%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%被拿走了%ITEMNAME:LOOT%…
		ITEM:LOOT --
	ELSEIF MONEY:2 >= REWARD
		PRINTFORMW 输掉的%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%被拿走了{REWARD}筹码…
		MONEY:2 -= REWARD
	ELSE
		REWARD *= 300
		PRINTFORMW 输掉的%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%被拿走了\@ MONEY > REWARD ? %金额表示(REWARD)%# 身上的所有钱\@…
		MONEY = MAX(MONEY - REWARD, 0)
	ENDIF
	RESETCOLOR
	RETURN 1
ENDIF

;source操作他
TCVAR:ENEMY:弹幕胜负不能 = 1
CFLAG:ENEMY:弹幕胜负胜利 = 1
CFLAG:ENEMY:败犬 = 1
CFLAG:ENEMY:经常去的地方 = CFLAG:MASTER:约会中

PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%面对跪地求饶的%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%…
CALL ASK_M("献上胖次作为祭品",1,"勒索筹码",1,"用身体补偿吧",1, "奇迹之石", ITEM:奇迹之石)
SELECTCASE RESULT
	CASE 0
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%让%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%把手高高举起、开始吟唱祈祷的咒语、透过衣服可以看到%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%的内裤开始亮起浅浅的光辉
		PRINTFORML 超自然的火炎愈发炽热、没有伤到%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%的衣服分毫、只有内裤本身燃烧殆尽了
		PRINTFORML 目睹了神威的%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%害怕地逃走了
		CALL BUFF_BASE(MASTER,BASE_TSP,500, 1)
		CALL BUFF_BASE(MASTER,BASE_精力,500, 1)
		FLAG:笃信 += 10
		;DELCHARA RANDOM_CHARANUM
		;ADDCHARA RANDOM_CHARANUM
		TARGET = 0
		RETURN 1
	CASE 1
		PRINTFORMW 欧拉！给老子把值钱的东西全都交出来！
		MONEY:2 += REWARD
		PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%从%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%那里抢来了{REWARD}筹码
		IF RAND:5 < ABL:ENEMY:战斗能力
			PRINTFORMW 又额外拿到了%ITEMNAME:LOOT%
			ITEM:LOOT ++
		ENDIF
		TARGET = 0
		;DELCHARA RANDOM_CHARANUM
		;ADDCHARA RANDOM_CHARANUM
		RETURN 1
	CASE 2
		PRINTFORML 告诉%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%、如果不想被检举到巫女那里的话今天一天都要听%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的命令
		IF TALENT:ENEMY:受虐狂
			PRINTFORM %NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%似乎在期待着之后要发生的
			PRINTFORM %TEXTR("惩罚/惩戒/报复/处罚/惩戒")%
			PRINTFORM 她%TEXTR("胸中澎湃/坐立不安/热切期待/心跳加速")%着
			PALAM:ENEMY:情欲 = PALAMLV:3
			ABL:ENEMY:欲望 = MAX(3, ABL:ENEMY:欲望)
			CALL COLORMESSAGE(@"%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%现在无论何时何地,只要不是在众人面前,都可以随时将她压在身下了",C_YELLOW,1) 
		ELSE
			MARK:ENEMY:反抗刻印 = 1
			CALL COLORMESSAGE(@"虽然%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%身上有了反抗刻印、但只要不在别人面前的话无论什么时候都可以按在地上侵犯",C_YELLOW,1)
		ENDIF
		PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%带着%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%意气风发地回去了
	CASE 3
		PRINTFORML 反瞪着%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%的同时、%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%握紧了手里的奇迹之石
		PRINTFORML 受到影响的%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%移开视线低下了头
		CFLAG:ENEMY:以身体为目的 = 1
		ITEM:奇迹之石 --
		ABL:ENEMY:亲密 = MAX(3, ABL:ENEMY:亲密)
		ABL:ENEMY:欲望 = MAX(3, ABL:ENEMY:欲望)
		CFLAG:ENEMY:积攒度 = 1000
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%把手放在了%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%的肩上、命令其今天一天都要服从自己的命令
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%老实地接受了
		CALL COLORMESSAGE(@"只要不在别人面前的话、无论什么时候都可以把%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%按在地上侵犯了",C_YELLOW,1)
		PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%带着%NAME_OUTPUT_TRANSLATION("CALLNAME", ENEMY)%意气风发地回去了
ENDSELECT

FLAG:约会的对象 = TARGET
CFLAG:TARGET:同行 = 180
CFLAG:MASTER:同行 = 180
CFLAG:ENEMY:清醒剂 = 600
CFLAG:ENEMY:据点来访 = 1
CFLAG:ENEMY:来访时间 = 0
CFLAG:ENEMY:回家时间 = 1440 + CFLAG:ENEMY:清醒剂
CFLAG:ENEMY:就寝时间 = 1440 + CFLAG:ENEMY:清醒剂
CFLAG:ENEMY:起床时间 = 0
CSTR:ENEMY:路人子PROFILE２ = 惨遭反击之后现在已经老实了

RETURN 1

@LOST_GYAKURE(ARG)
#DIM 性交回数
#DIM 射精回数
性交回数 = MAX(1, CFLAG:ARG:积攒度 / 100)
射精回数 = MAX(1, BASE:MASTER:精力 / 100)
BASE:MASTER:体力 = 0
BASE:MASTER:气力 = 0
;BASE:MASTER:精力 = 0
;射精处理
CALL ADD_SAMEN_V(ARG, BASE:MASTER:精力)
EXP:ARG:精液经验 += 射精回数
EXP:ARG:膣射经验 += 射精回数
EXP:ARG:Ｖ性交经验 += 性交回数
EXP:ARG:Ｖ经验 += 性交回数
EXP:MASTER:绝顶经验 += 射精回数
EXP:MASTER:射精经验 += 射精回数
EXP:MASTER:插入经验 += 性交回数
CFLAG:ARG:积攒度 = 0
IF TALENT:ARG:处女
	CSTR:ARG:处女丧失履历 = 发情中に%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%を袭って舍てた
	TALENT:ARG:处女 = 0
ENDIF
CSTR:ARG:路人子PROFILE２ = %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%を贪り尽くしたことがある
CALL SET_SLEEP(1,MASTER,0)
CFLAG:MASTER:就寝时间 = DAY * 1440 + TIME + 120 + RAND:120
TFLAG:106 = 0
BEGIN AFTERTRAIN

;IF TIME:2 >= 5 && TIME:2 <= 7 && TIME:5 < 2
;	CALL COLORMESSAGE(@"满月的光芒激发了%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的本能…！",C_YELLOW,1)
;	CALL COLORMESSAGE(@"%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的战斗力提升了！",C_YELLOW,1)
;ENDIF

;モブ娘エンカウント率上升
@MOB_BATTLE_ENCOUNT
#FUNCTION
#DIM 月の状态
IF FLAG:异常气象 == 8 && TCVAR:RANDOM_CHARANUM:发情
	RETURNF 1
ELSEIF  TCVAR:RANDOM_CHARANUM:祈愿桃色の风
	RETURNF 1
ELSE
	月の状态 = MOON_WATCH(DAY:3)
	;满月
	IF 月の状态 == 9
		SELECTCASE FLAG:抱负
			CASE 6
				;抱负が子孙繁栄
				RETURNF 1
			CASE 9
				;子孙繁栄达成済み
				SIF RAND:5 == 0
					RETURNF 1
		ENDSELECT
		SIF RAND:10 == 0
			RETURNF 1
	;新月
	ELSEIF 月の状态 == 1 && RAND:3 == 0
		RETURNF 1
	ENDIF
ENDIF
RETURNF 0
