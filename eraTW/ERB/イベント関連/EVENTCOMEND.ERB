;FileName_EVENTCOMEND.ERB -------------------------- Rev1.00
;ターン结束の处理
;CALL		SYSTEM
;ARG		VOID
;RETURN		VOID
;COMMENT	
;-----------------------------------------------------------
@EVENTCOMEND
#DIM 装备部位
;仕事动作のエラーチェック
;FOR LOCAL,0,CHARANUM
;	SIF CFLAG:LOCAL:326 == 0 && CFLAG:LOCAL:行动 == 5
;		PRINTFORMW ### COM_END 326ERROR %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)% ### CHARA_NO:{LOCAL}
;	SIF CFLAG:LOCAL:当前位置 == 0
;		PRINTFORMW ### COM_END LOCATION ERROR %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)% の当前位置が异常です ### CHARA_NO:{LOCAL}
;NEXT
;ターン结束共通处理
CALL TURN_RESET

SIF FLAG:宴会举办FLAG > 0
	CALL ENKAI_SINKOU

SIF TFLAG:102 < 2 && TARGET && SHIRAHU(TARGET) && !FLAG:70
	CALL ボッシュート
IF BASE:MASTER:酒气 >= MAXBASE:MASTER:酒气
	;AT_HOMEみるだけでも良いかもしれない
	IF !AT_HOME(MASTER) && GET_MAPID(CFLAG:MASTER:当前位置) != MAIN_MAP
		CALL 约会结束タイムUP处理
	ELSE
		PRINTFORMW 持续痛饮直到极限的%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%、就这样突然倒下了…
	ENDIF
	GOTO OYASUMI
ENDIF
IF BASE:MASTER:体力 <= 500 && ITEM:逆之羽
	FONTSTYLE 1
	PRINTFORML 羽毛放出光辉　安静的燃烧殆尽了！
	FONTREGULAR
	CALL RECOVER_PERMIL(MASTER, 300, "体力", 0, "逆之羽所获得的恢复")
	CALL RECOVER_PERMIL(MASTER, 200, "气力", 0, "逆之羽所获得的恢复")
	ITEM:逆之羽 --
ELSEIF (BASE:MASTER:体力 <= 500 && !TCVAR:TARGET:随便) || BASE:MASTER:体力 <= 0
	PRINTL （体力濒临极限）
	;发情无崩しお房间上がり込みorにゅーぷらんの场合は选择肢を出さない
	IF CFLAG:MASTER:当前位置 == OMANEKIBEYA() && (!TALENT:TARGET:恋慕 || TFLAG:泡澡堂)

	ELSE
		;被逆推中なら分岐
		IF TFLAG:102 == 3 && BASE:MASTER:体力 > 0 && !TCVAR:TARGET:随便
			CALL ASK_YN("随她去吧", "求放开")
			IF !RESULT
				TCVAR:TARGET:随便 = 1
				BASE:MASTER:体力 -= 250
				GOTO SUKINISITE
			ENDIF
		ENDIF
	ENDIF
	PRINTW 　一天过去了
	IF BASE:MASTER:体力 <= 0 && !CHK_DATENOW(CFLAG:MASTER:约会中)
		PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%体力不支晕过去了…
		FLAG:气绝中断 = 100 + CFLAG:MASTER:当前位置 / 100
	ENDIF
	;被逆推中ならTARGETに嗜虐经验
	IF TFLAG:102 == 3
		IF BASE:MASTER:体力 <= 0
			EXP:嗜虐快乐经验 += 10
			PRINTL 
			PRINTFORMW 嗜虐快乐经验 +10(%CALLNAME%)
			PRINTL 
		ELSE
			EXP:嗜虐快乐经验 += 2
			PRINTL 
			PRINTFORMW 嗜虐快乐经验 +2(%CALLNAME%)
			PRINTL 
		ENDIF
	ENDIF
	$OYASUMI
	CALL SET_SLEEP(1,MASTER,0)
	CFLAG:MASTER:就寝时间 = DAY * 1440 + TIME
	;外泊できる状态ならそのまま寝る（恋慕前提）
	IF CFLAG:MASTER:当前位置 == OMANEKIBEYA() && !TCVAR:(CFLAG:MASTER:招待):连住禁止
		IF CFLAG:(CFLAG:MASTER:招待):约会中 && TALENT:TARGET:恋慕
			PRINTFORMW 今天%NAME_OUTPUT_TRANSLATION("CALLNAME", (CFLAG:MASTER:招待))%提供了住宿的样子
			FLAG:气绝中断 = 0
		;发情无崩しお房间上がり込みの场合
		ELSE
			PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", (CFLAG:MASTER:招待))%也差不多到了清醒过来的时候了吧、是时候离开了…
			IF TFLAG:102 >= 2
				PRINTFORMW 挣脱开紧紧抱住的%NAME_OUTPUT_TRANSLATION("CALLNAME", (CFLAG:MASTER:招待))%、回到了%GET_MAPNAME(MAIN_MAP)%…
			ELSE
				PRINTFORMW 仿佛要避开%NAME_OUTPUT_TRANSLATION("CALLNAME", (CFLAG:MASTER:招待))%火热的的视线一般、回到了%GET_MAPNAME(MAIN_MAP)%…
			ENDIF
			;房间的污垢を保存しておく
			IF YOGORE:(OMANEKIBEYA()) > 0
				TCVAR:(CFLAG:MASTER:招待):待客室的污垢 = YOGORE:(OMANEKIBEYA())
			ELSE
				;０以下にした场合は识别するために１残す
				TCVAR:(CFLAG:MASTER:招待):待客室的污垢 = 1
			ENDIF
			;招待フラグに0を代入
			CFLAG:TARGET:招待 = 0
			CFLAG:MASTER:招待 = 0
			FLAG:气绝中断 = 0
			CFLAG:MASTER:当前位置 = ENTRANCE
			PRINTW 
		ENDIF
	ELSEIF TFLAG:泡澡堂 && CFLAG:诶嘿嘿
		PRINTFORMW 
		CALL 泡澡堂结束判定("你限界")
		IF MAIN_MAP != 9
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%用尽最后的力量、回到了%GET_MAPNAME(MAIN_MAP)%
			FLAG:气绝中断 = 100 + CFLAG:MASTER:当前位置 / 100
			CFLAG:MASTER:当前位置 = ENTRANCE
		ELSE
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%摇摇晃晃地、回到了私室
			CFLAG:MASTER:当前位置 = CFLAG:MASTER:311
			FLAG:气绝中断 = 0
		ENDIF
	ELSEIF TARGET > 0 && TALENT:TARGET:恋慕 && BASE:TARGET:体力 >= 500 && !CFLAG:TARGET:睡眠 && !CFLAG:MASTER:陪睡中 && ((CFLAG:TARGET:同行 && CHK_DATENOW(CFLAG:MASTER:约会中)) || !CHK_DATENOW(CFLAG:MASTER:约会中))
		IF CHK_DATENOW(CFLAG:MASTER:约会中)
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%支撑着%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%回到了%GET_MAPNAME(MAIN_MAP)%
		ENDIF
		IF CFLAG:MASTER:当前位置 != CFLAG:MASTER:初始位置
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%把%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%送回了私室…
			CFLAG:MASTER:当前位置 = CFLAG:MASTER:311
			;おやすみ口上,6-0,MASTERがダウン（房间に运ばれる）
			CALL KOJO_MESSAGE_SEND("EVENT", 3, TARGET, 6, 0)
		ELSE
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%把%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%送到了\@ INROOM(CFLAG:MASTER:当前位置) == 2 ? 床上 # 被窝 \@…
			;おやすみ口上,6-1,MASTERがダウン（自室）
			CALL KOJO_MESSAGE_SEND("EVENT", 3, TARGET, 6, 1)
		ENDIF
		CFLAG:MASTER:约会中 = MAIN_MAP
		FLAG:气绝中断 = 0
	ELSEIF CFLAG:MASTER:当前位置 == P54小人的虫笼
		CFLAG:MASTER:当前位置 = P10走廊
		PRINTFORMW 不知什么时候%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%滚到了走廊上…
	ELSEIF CHK_DATENOW(CFLAG:MASTER:约会中)
		PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%用尽最后的力量、回到了%GET_MAPNAME(MAIN_MAP)%
		FLAG:气绝中断 = 100 + CFLAG:MASTER:当前位置 / 100
		CFLAG:MASTER:当前位置 = ENTRANCE
		PRINTFORMW 
	ELSE
		PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%摇摇晃晃地、回到了私室
		CFLAG:MASTER:当前位置 = CFLAG:MASTER:311
		FLAG:气绝中断 = 0
	ENDIF
	FOR LOCAL,0,CHARANUM
		SIF CFLAG:LOCAL:出禁
			CONTINUE
		CALL ENDUFUFU(LOCAL)
		CALL SET_PRANK(0,LOCAL)
		CFLAG:LOCAL:约会中 = MAIN_MAP
		CFLAG:LOCAL:同行 = 0
		FLAG:约会的对象 = 0
		TFLAG:约会前好感度 = 0
		SIF !BATHCHECK(CFLAG:LOCAL:当前位置) && TEQUIP:LOCAL:浴室PLAY
			TEQUIP:LOCAL:浴室PLAY = 0
	NEXT
;	数值变量が小数点以下を切り舍てる特性を恶用したものがこちら、他の变量を不使用分こちらのほうがいいのかも？
	CFLAG:MASTER:约会中 = CFLAG:MASTER:当前位置 / 100
	TFLAG:106 = 0
	BEGIN AFTERTRAIN
ENDIF
IF TARGET && TFLAG:吻痕 == TARGET && TFLAG:绷带 && !RAND:2
	PRINTFORMW 察觉到%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的脖子上被包住的东西的%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%、拉开了绷带
	TFLAG:绷带 = 0
	BASE:愤怒 += 500
ENDIF
$SUKINISITE
IF TARGET && CFLAG:心情不快 && !FLAG:70 && !TCVAR:强行 && !CFLAG:败犬
	IF TALENT:TARGET:胆量 < 0
		PRINTFORMW 把%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%弄哭了…
		CALL KOJO_MESSAGE_SEND("EVENT",29,TARGET,2,0)
	ELSE
		PRINTFORMW 把%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%惹火了…
		CALL KOJO_MESSAGE_SEND("EVENT",29,TARGET,1,0)
	ENDIF
	
	IF FLAG:守矢神签约会的对象 != TARGET
		FOR LOCAL,0,CHARANUM
			CALL ENDUFUFU(LOCAL)
		NEXT
		TFLAG:106 = 0
	ELSEIF CFLAG:诶嘿嘿 && TFLAG:泡澡堂
		CALL 泡澡堂结束判定("女の子不高兴")
	ENDIF
ENDIF

IF FLAG:70 == 1
	IF BASE:MASTER:TSP <= 0
		PRINTFORML (TSP用完了)
		[SKIPSTART]
		FOR LOCAL,1,CHARANUM
			IF CFLAG:LOCAL:当前位置 == CFLAG:PLAYER:当前位置
				FOR 装备部位,0,23
					SIF (!睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(200 + 装备部位)) || (睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(240 + 装备部位))
						LOCAL:1 ++
					SIF 装备部位 == 6 && CFLAG:LOCAL:没穿内裤 && ((!睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(200 + 装备部位)) || (睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(240 + 装备部位)))
						LOCAL:1 --
				NEXT
				IF LOCAL:1
					EQUIP:LOCAL:0 = 1
					IF CFLAG:LOCAL:时间停止换装 == 1
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%把%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%\@ CFLAG:LOCAL:没穿内裤 ? 内裤以外的 #  \@地方弄回了之前的样子！
						CFLAG:LOCAL:时间停止换装 = 0
					ELSE
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%给%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%穿上了\@ CFLAG:LOCAL:没穿内裤 ? 内裤以外的 #  \@衣服
					ENDIF
				ENDIF
			ENDIF
		NEXT
		[SKIPEND]
		IF CFLAG:MASTER:当前位置 != OMANEKIBEYA()
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%慌忙离开了现场
			TFLAG:运搬 = 0
			CALL FISHER_YATES_SHAFFLE(CHARANUM - 1)
			FOR LOCAL:10, 0, CHARANUM - 1
				LOCAL = SHAFFLE_ARRAY:(LOCAL:10) + 1
				SIF CFLAG:LOCAL:当前位置 != CFLAG:MASTER:当前位置
					CONTINUE
				IF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 60
					PRINTFORMW 如潮水般涌来的快感令%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%翻着白眼、吐着舌头瘫坐在地上不住娇喘
					CFLAG:LOCAL:333 += 30
				ELSEIF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 40
					PRINTFORMW 突然袭来的激烈绝顶令%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%发出甜美的娇喘声、当场瘫坐在地
					CFLAG:LOCAL:333 += 20
				ELSEIF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 20
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%因为突如其来的谜之快感身体发软
					CFLAG:LOCAL:333 += 10
				ELSEIF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 0
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%因为谜之快感身体猛地僵硬起来
				ELSEIF CFLAG:LOCAL:291 == 1
					PRINTFORMW 不知什么时候内裤被脱掉的%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%一幅坐立不安的样子
				ENDIF
				SIF EX:LOCAL:处女丧失记号 == 1
					PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%因为股间的钝痛而紧皱着眉头…
			NEXT
			IF !AT_HOME(MASTER)
				PRINTFORML 往%GET_MAPNAME(MAIN_MAP)%全速疾奔而去…
				BASE:MASTER:体力 -= TIME_REQUIRED(MAIN_MAP,CFLAG:MASTER:约会中) * 5
				BASE:MASTER:气力 -= TIME_REQUIRED(MAIN_MAP,CFLAG:MASTER:约会中) * 5
				BASE:MASTER:体力 = MAX(BASE:MASTER:体力,0)
				BASE:MASTER:气力 = MAX(BASE:MASTER:气力,0)
				TIME += TIME_REQUIRED(MAIN_MAP,CFLAG:MASTER:约会中) / 5
			ENDIF
			IF CFLAG:MASTER:当前位置 != CFLAG:MASTER:初始位置
				CFLAG:MASTER:当前位置 = CFLAG:MASTER:初始位置
			ELSE
				CFLAG:MASTER:当前位置 = 避难处
			ENDIF
			BASE:MASTER:TSP = 0
			CALL AFTER_AFFAIR
			FOR LOCAL,0,CHARANUM
				;MASTERがいなくなったあとなのに表示されるのがおかしいし、时间停止解除时にそぐわない口上が呼び出される危险性が高いし、口上ギミックを破坏する可能性が高いのでコメントアウト
				[SKIPSTART]
				IF CFLAG:LOCAL:诶嘿嘿 == 1 && LOCAL != 0
					;诶嘿嘿结束口上呼び出し
					CALL KOJO_MESSAGE_SEND("EVENT",15,LOCAL,2,0)
				ENDIF
				[SKIPEND]
				CALL ENDUFUFU(LOCAL)
				CFLAG:LOCAL:约会中 = MAIN_MAP
			NEXT
			FLAG:约会的对象 = 0
			TFLAG:约会前好感度 = 0
			TFLAG:106 = 0
		ELSE
			CALL FISHER_YATES_SHAFFLE(CHARANUM - 1)
			FOR LOCAL:10, 0, CHARANUM - 1
				LOCAL = SHAFFLE_ARRAY:(LOCAL:10) + 1
				IF CFLAG:LOCAL:当前位置 == CFLAG:MASTER:当前位置
					IF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 60
						PRINTFORMW 如潮水般涌来的快感令%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%翻着白眼、吐着舌头瘫坐在地上不住娇喘
						CFLAG:LOCAL:333 += 30
					ELSEIF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 40
						PRINTFORMW 突然袭来的激烈绝顶令%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%发出甜美的娇喘声、当场瘫坐在地
						CFLAG:LOCAL:333 += 20
					ELSEIF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 20
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%因为突如其来的谜之快感身体发软
						CFLAG:LOCAL:333 += 10
					ELSEIF EX:LOCAL:Ｃ绝顶 + EX:LOCAL:Ｖ绝顶 + EX:LOCAL:Ａ绝顶 + EX:LOCAL:Ｂ绝顶 + EX:LOCAL:Ｍ绝顶 > 0
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%因为谜之快感身体猛地僵硬起来
					ELSEIF CFLAG:LOCAL:291 == 1
						PRINTFORMW 不知什么时候内裤被脱掉的%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%一幅坐立不安的样子
					ENDIF
					SIF EX:LOCAL:处女丧失记号 == 1
						PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%因为股间的钝痛而紧皱着眉头…
				ENDIF
				CALL ENDUFUFU(LOCAL)
			NEXT
			CFLAG:MASTER:诶嘿嘿 = 0
		ENDIF
		FLAG:70 = 0
		RESETBGCOLOR
		;(天候パッチ)时刻・天候に応じて背景色を变更
		CALL SET_MAP_WEATHER_BGCOLOR
		BASE:MASTER:TSP = 0
	ENDIF
	SIF CFLAG:MASTER:诶嘿嘿 && BASE:MASTER:勃起 <= 900 && BASE:MASTER:精力 >= 500
		BASE:MASTER:勃起 += 10
ENDIF
;魔改睡奸添加代码【&& CFLAG:睡眠 == 0】，睡醒之前不执行衰弱判定。眼罩强化启动后无视体力过低导致的衰弱判定，【&& (TEQUIP:眼罩 == 0 || Eye_mask_Blessing == 0)】
IF TARGET && BASE:体力 < 500 && !TCVAR:TARGET:休憩中 && CFLAG:睡眠 == 0 && (TEQUIP:眼罩 == 0 || Eye_mask_Blessing == 0)
	IF FLAG:70 == 1 && CFLAG:MASTER:当前位置 != OMANEKIBEYA()
		IF !CFLAG:衰弱
			PRINTFORML （%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的体力濒临了极限）
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%离开了这个地方、解除了时间停止
			CFLAG:衰弱 = 360
			FLAG:70 = 0
			FLAG:约会的对象 = 0
			TFLAG:约会前好感度 = 0
			;(天候パッチ)时刻・天候に応じて背景色を变更
			CALL SET_MAP_WEATHER_BGCOLOR
			RESETBGCOLOR
			IF AT_HOME(MASTER)
				CFLAG:MASTER:约会中 = MAIN_MAP
				IF CFLAG:MASTER:当前位置 != CFLAG:MASTER:初始位置
					CFLAG:MASTER:当前位置 = CFLAG:MASTER:初始位置
				ELSE
					CFLAG:MASTER:当前位置 = 避难处
				ENDIF
			ELSE
				IF STR:(6000 + CFLAG:MASTER:当前位置 + 10) == ""
					CFLAG:MASTER:当前位置 -= 10
				ELSE
					CFLAG:MASTER:当前位置 += 10
				ENDIF
			ENDIF
		ENDIF
		CALL CHARA_SLEEP, TARGET, 0
		FOR LOCAL,0,CHARANUM
			CALL ENDUFUFU(LOCAL)
			CALL SET_PRANK(0,LOCAL,1)
			SIF LOCAL
				CFLAG:LOCAL:约会中 = MAIN_MAP
			CFLAG:LOCAL:同行 = 0
		NEXT
		FLAG:约会的对象 = 0
		TFLAG:约会前好感度 = 0
		TFLAG:106 = 0
	ELSEIF TFLAG:泡澡堂
		CALL 泡澡堂结束判定("体力限界")
	ELSE
		IF !CFLAG:衰弱
			PRINTFORMW （%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%的体力濒临了极限）
			CFLAG:衰弱 = 360
			FLAG:70 = 0
			;(天候パッチ)时刻・天候に応じて背景色を变更
			CALL SET_MAP_WEATHER_BGCOLOR
		ENDIF
		CALL CHARA_SLEEP, TARGET, 1
		FOR LOCAL,0,CHARANUM
			CALL ENDUFUFU(LOCAL)
			CALL SET_PRANK(0,LOCAL,1)
			SIF LOCAL
				CFLAG:LOCAL:约会中 = MAIN_MAP
			CFLAG:LOCAL:同行 = 0
		NEXT
		FLAG:约会的对象 = 0
		TFLAG:约会前好感度 = 0
		TFLAG:106 = 0
	ENDIF
ENDIF

IF GET_EXISTMOB(MAIN_MAP)
	FOR LOCAL, MINROOM(), MAXROOM
		IF ROOMDATA:(LOCAL % 100) & 场所_路人
			YOGORE:LOCAL += TIME_PROGRESS(TIME:1) * MOB_YOGORE(MAIN_MAP)
			SIF CFLAG:MASTER:当前位置 == LOCAL
				TRYCALLFORM MOB_TURNENDEVENT_{MAIN_MAP}
		ENDIF
	NEXT
ENDIF
IF !FLAG:70 && TARGET
	IF TALENT:TARGET:动物耳 && CFLAG:TARGET:900 == 7 && !TCVAR:TARGET:发情 && PALAM:TARGET:情欲 >= PALAMLV:5 && !TALENT:TARGET:妊娠
		PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%脸颊泛红、气息慌乱起来…
		PRINTFORML 在危险日极度兴奋起来的%NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%好像[发情]了
		TCVAR:TARGET:发情 = 1
	ENDIF
ENDIF

FOR LOCAL,0, CHARANUM
	SIF TIME > TCVAR:LOCAL:追い出され时刻 + 30
		TCVAR:LOCAL:追い出され地点 = 0
	;IF !CFLAG:LOCAL:诶嘿嘿
		FOR LOCAL:2,101,109
			SIF TEQUIP:LOCAL:(LOCAL:2) != TEQUIP:LOCAL:(LOCAL:2 + 10)
				TEQUIP:LOCAL:(LOCAL:2) = 0
		NEXT
	;ENDIF
	;日记の书き込み判定
	CALL KOJO_MESSAGE_SEND("DIARY", 0, LOCAL, 0, 0, "BEFORE_CHECK")
	SIF CFLAG:LOCAL:当前位置 == SUKIMA()
		CONTINUE
[SKIPSTART]
	;今日の挨拶をしてなかった场合遭遇时挨拶口上を出す
	IF LOCAL > 0 && !TCVAR:LOCAL:今天有否见面 && CFLAG:MASTER:当前位置 == CFLAG:LOCAL:当前位置 && !FLAG:70
		IF CFLAG:LOCAL:认识 == 0
			CALL SYOTAIMEN(LOCAL)
		ELSEIF CHK_DATENOW(CFLAG:MASTER:约会中)
			CALL KOJO_MESSAGE_SEND("EVENT",1,LOCAL,9,FLAG:约会的对象)
		ELSE
			CALL KOJO_MESSAGE_SEND("EVENT",1,LOCAL,8,0)
		ENDIF
		CALL FirstMeetToday(LOCAL)
	ENDIF
[SKIPEND]
	;衣装の更衣直しは@SHOW_STATUSに移动
	[SKIPSTART]
	LOCAL:1 = 0
	FOR 装备部位,0, 23
		SIF (!睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(200 + 装备部位)) || (睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(240 + 装备部位))
			LOCAL:1 ++
		SIF 装备部位 == 6 && CFLAG:LOCAL:没穿内裤 && ((!睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(200 + 装备部位)) || (睡眠时间(LOCAL) && EQUIP:LOCAL:装备部位 != CFLAG:LOCAL:(240 + 装备部位)))
			LOCAL:1 --
	NEXT
	IF !CFLAG:LOCAL:诶嘿嘿 && CFLAG:LOCAL:当前位置 != BATHROOM(CFLAG:LOCAL:当前位置) && LOCAL:1
		IF 睡眠时间(LOCAL)
			;睡衣セット
			CALL CTRL_CLOTHES_SET(LOCAL, "现在衣装の变更_睡衣")
			CFLAG:LOCAL:睡衣 = 1
		ELSE
			;便装セット
			CALL CTRL_CLOTHES_SET(LOCAL, "现在衣装の变更_便装")
			CFLAG:LOCAL:睡衣 = 0
		ENDIF
		SIF !睡眠时间(LOCAL) && CFLAG:LOCAL:眠奸发觉
			CFLAG:LOCAL:眠奸发觉 = 0
		CALL CLOTHES_SETTING_TRAIN(LOCAL)
	ENDIF
	[SKIPEND]
	;いちおうCLOTHES_SETTING_TRAINはやって损はなかろう
		SIF !睡眠时间(LOCAL) && CFLAG:LOCAL:眠奸发觉
			CFLAG:LOCAL:眠奸发觉 = 0
		CALL CLOTHES_SETTING_TRAIN(LOCAL)
NEXT
;强制的にWAITが追加されるのを回避するためにTWAITを仕込む
;これで入力回数が１回减る
IF CFLAG:MASTER:当前位置 == 99
	SETCOLOR C_RED
	PRINTFORMW ### COM_END LOCATION ERROR! %NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%在应该不存在的地方！ ###
	PRINTW 强制地结束一天。请取得日志、提出错误报告。
	RESETCOLOR
	CFLAG:MASTER:当前位置 = CFLAG:MASTER:311
	CALL SET_SLEEP(1,MASTER,0)
	TFLAG:106 = 0
	BEGIN AFTERTRAIN
ENDIF
	;CFLAG:MASTER:就寝时间 = DAY * 1440 + TIME
SIF SELECTCOM == 400
	TWAIT 100,0

@ENKAI_SINKOU
SIF FLAG:宴会举办FLAG == 0 || TFLAG:宴会状态 == 101
	RETURN

;宴会の参加人数をセット
CALL 宴会参加人数再计算()

;天气が恶いと中止になる宴会もある

IF TIME:5 >= 4 && FLAG:36 > 0 && GROUPMATCH(CFLAG:[[天子]]:宴会参加, 1, 2)
	PRINTFORMW 以为会因为恶劣的天气而终止的宴会、在天子的能力下天空放晴了
	TIME:5 = 0
	;(天候パッチ)风速を0にする
	WIND_VELOCITY = 0
	;(天候パッチ)1日が终わるまで天候变更を禁止する
	FORBIDDEN_CHANGE_WEATHER = 1
ENDIF
IF TIME:5 >= 4 && FLAG:36 > 0 && DAY >= FLAG:开始日 && TIME >= FLAG:33
	PRINTL  
	PRINTFORMW 很遗憾、\@ CFLAG:MASTER:当前位置 == TFLAG:宴会场 ? 由于天气不好的原因宴会中止了 # 很遗憾、由于坏天气的原因宴会似乎要中止了\@
	CALL ENKAI_STOP
;宴会の途中で降り始めた场合
ELSEIF TFLAG:宴会状态 >= 98 && TIME:5 >= 4 && FLAG:36 > 0
	PRINTL  
	PRINTFORMW 很遗憾、\@ CFLAG:MASTER:当前位置 == TFLAG:宴会场 ? 由于天气不好的原因宴会中止了 # 很遗憾、由于坏天气的原因宴会似乎要中止了\@
	CALL ENKAI_STOP
;宴会开始
ELSEIF 宴会开始日判定() && TIME >= FLAG:33
	IF CFLAG:MASTER:当前位置 == TFLAG:宴会场
		PRINTFORML 
		IF FLAG:参加人数 < 2
			PRINTW 在恬静的气氛中、宴会开始了…
		ELSEIF FLAG:参加人数 >= 8
			PRINTW 在热闹的气氛中、宴会开始了…
		ELSE
			PRINTW 在祥和的气氛中、宴会开始了…
		ENDIF
		PRINTFORML 
		TFLAG:宴会状态 = 99
	ELSE
		TFLAG:宴会状态 = 98
	ENDIF
ELSEIF TFLAG:宴会状态 == 98 && DAY >= FLAG:开始日 && TIME >= FLAG:33
	IF CFLAG:MASTER:当前位置 == TFLAG:宴会场
		PRINTL  
		PRINTW 宴会好像已经开始了的样子…
		PRINTL  
		TFLAG:宴会状态 = 99
	ENDIF
	;主催者侧はまだ宴会准备フラグのままのため、フラグを强行进める
	FOR LOCAL,0,CHARANUM
		SIF CFLAG:LOCAL:20 == 2
			CALL ENKAI_WORK(LOCAL)
	NEXT
ELSEIF 宴会举办中判定() && FLAG:参加人数 == 0
	IF CFLAG:MASTER:当前位置 == TFLAG:宴会场
		PRINTL
		;PRINTW 宴会はお开きのようです…
		PRINTW 宴会好像要结束了…
		PRINTL
		TFLAG:宴会状态 = 101
	ELSE
		TFLAG:宴会状态 = 100
	ENDIF
ELSEIF TFLAG:宴会状态 == 100 && CFLAG:MASTER:当前位置 == TFLAG:宴会场
	PRINTL
	;PRINTW もう宴会は终わっているようです…
	PRINTW 宴会好像已经结束了…
	PRINTL
	TFLAG:宴会状态 = 101
ENDIF
