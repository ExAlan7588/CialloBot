@来访フラグ
#DIM 来访者数

#DIM 来访概率
#DIM 基本来访概率
#DIM 来访人数上限
#DIM 来访连锁

;LOCAL = 各角色のNO 
来访者数 = 0
来访概率 = 0
基本来访概率 = 0
CVARSET CFLAG, GETNUM(CFLAG, "据点来访")
;出禁人数に応じて基本来访率の调整。实数でなく割合计算に变更しています
SELECTCASE FLAG:出禁人数 * 100 / CHARANUM
CASE IS >= 60
	基本来访概率 = 15
CASE IS >= 40
	基本来访概率 = 16
CASE IS >= 20
	基本来访概率 = 17
CASEELSE
	基本来访概率 = 18
ENDSELECT

IF TALENT:MASTER:千客万来
	来访人数上限 = 30
ELSE
	来访人数上限 = 20
ENDIF
;まず确定で来る角色をカウント
FOR LOCAL,1,CHARANUM
	;口上の每天早上イベント
	CALL KOJO_MESSAGE_SEND("BEFORETRAIN", 0, LOCAL)
	IF CFLAG:LOCAL:宴会参加
		IF IN_HOME(FLAG:32)
			CFLAG:LOCAL:据点来访 = 1
			CFLAG:LOCAL:最后来访的日期 = DAY
			来访者数 ++
		;ただし神社外なら确实に来ない（酒>>（越えられない壁）>>恋人の你）
		ELSE
			CFLAG:LOCAL:据点来访 = 0
		ENDIF
	;祈愿对象／依赖实行中及び达成者は来访する
	; // 自宅メンバーは祈愿フラグがONでも来访不会うに from祈愿パッチ.ERB//
	ELSEIF 来访可能(LOCAL, "强制") && (CFLAG:LOCAL:翌日来访 || CFLAG:LOCAL:依赖状况 == 3)
		CFLAG:LOCAL:据点来访 = 1
		CFLAG:LOCAL:最后来访的日期 = DAY
		来访者数 ++
	ELSE
		CFLAG:LOCAL:据点来访 = 0
	ENDIF
NEXT

CALL FISHER_YATES_SHAFFLE(CHARANUM - 1)
FOR LOCAL:10 , 0 , CHARANUM - 1
	LOCAL = SHAFFLE_ARRAY:(LOCAL:10) + 1
	;出禁人数＋各素質による修正から来访率を算出し、判定
	;一部角色には追加で条件や概率变动が存在
	SIF FLAG:交流来访模式 == 3
		BREAK
	;来访者数が来访人数上限を超えると结束
	SIF 来访者数 >= 来访人数上限
		BREAK
	;すでに来访フラグが立っていれば判定しない
	SIF CFLAG:LOCAL:据点来访
		CONTINUE
	SIF !来访可能(LOCAL)
		CONTINUE
	来访概率 = 基本来访概率 - TALENT:LOCAL:恋慕 * 2 - TALENT:LOCAL:思慕 - CFLAG:LOCAL:(420 + MAIN_MAP)
	SIF CFLAG:LOCAL:自慰暴露
		来访概率 += 5
	;最初の一ヶ月は补正无
	IF DAY > 30
		;最后来访的日期が近いほど来访しにくい
		IF DAY - CFLAG:LOCAL:最后来访的日期 < 4
			来访概率 += 100
		ELSEIF DAY - CFLAG:LOCAL:最后来访的日期 < 8
			来访概率 += 10
		ELSEIF DAY - CFLAG:LOCAL:最后来访的日期 > 20
			来访概率 = 来访概率 * 3 / 4
		ELSEIF DAY - CFLAG:LOCAL:最后来访的日期 > 30
			来访概率 = 来访概率 * 2 / 3
		ENDIF
	ENDIF
	IF !RAND:(来访概率 + CFLAG:LOCAL:来访抑制值)
		CFLAG:LOCAL:据点来访 = 1
		CFLAG:LOCAL:最后来访的日期 = DAY
		来访者数 ++
	ELSE
		CFLAG:LOCAL:据点来访 = 0
	ENDIF
	;相性の良い角色が一绪に来访してくるシステム(最大2人まで)
	来访连锁 = 0
	IF CFLAG:LOCAL:据点来访
		FOR LOCAL:11, 1, CHARANUM - 1
			LOCAL:1 = SHAFFLE_ARRAY:(LOCAL:11) + 1
			IF RELATION:LOCAL:(LOCAL:1) > 100 && 来访可能(LOCAL:1) && 来访者数 < 来访人数上限 && 来访连锁 < 2
				;相性200%で50%,120%で30%
				IF RAND:100 < RELATION:LOCAL:(LOCAL:1) / 4
					CFLAG:(LOCAL:1):据点来访 = 1
					CFLAG:(LOCAL:1):最后来访的日期 = DAY
					来访者数 ++
					来访连锁 ++
				ENDIF
			ENDIF
		NEXT
	ENDIF
NEXT


;外泊中は非表示
IF 来访者数 > 0 && AT_HOME(MASTER)
	PRINTFORMW %GET_MAPNAME(MAIN_MAP)%好像有来访者的样子。
	PRINTL
ENDIF

SIF FamilyHotel < 2 || MAIN_MAP > 0 	;&& 来访者数 == 0
	RETURN
PRINTFORML 昨日来访者住宿收益:     (评价好坏会影响好感/信赖变化哟)
FOR LOCAL, 1, CHARANUM - 1
	FOR LOCAL:1, 61, 67
		IF CFLAG:LOCAL:神社在住 == LOCAL:1
			CFLAG:LOCAL:神社在住 = 0
			SIF MAIN_MAP == 0
				CFLAG:LOCAL:据点来访 = 1
			CFLAG:LOCAL:初始位置 = CSVCFLAG(LOCAL, GETNUM(CFLAG, "初始位置"))
			IF CFLAG:LOCAL:初始位置 < 57
				CFLAG:LOCAL:神社在住 = CSVCFLAG(LOCAL, GETNUM(CFLAG, "初始位置"))
				CFLAG:LOCAL:据点来访 = 0
				;#;PRINTFORM 神社原住民 {CFLAG:LOCAL:神社在住}-%NAME_FROM_PLACE(CFLAG:LOCAL:神社在住)%  
			ENDIF
		PRINTFORM 住在%NAME_FROM_PLACE(8000 + LOCAL:1)%的
SETCOLOR 0x66FFFF
		PRINTFORM %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL),12,Left%
RESETCOLOR 
		PRINTFORM %TEXTR("的个人感觉/和朋友谈论/投稿了《文文。新闻》/记录下来了/投稿了《花果子念报》")%:
		PRINTFORM %TEXTR("豪华别墅/这家旅社/这个地方")%的
		PRINTFORM %TEXTR("住宿环境/大落地镜/软绵大床/超大浴缸/周边景色")%实在是
	LOCAL:2 = 500 + (5000 - YOGORE:(LOCAL:1))/10	;住宿费
	SELECTCASE YOGORE:(LOCAL:1)
		CASE IS < 250
			SETCOLOR C_GREEN
			PRINTFORM 棒极了!
			CFLAG:LOCAL:信赖度 += 5
		CASE IS < 500
			SETCOLOR C_M_GREEN
			PRINTFORM 非常赞!
			CFLAG:LOCAL:信赖度 += 2
		CASE IS < 1000
			SETCOLOR C_P_GREEN
			PRINTFORM 还可以!
			CFLAG:LOCAL:信赖度 += 1
		CASE IS < 2000
			SETCOLOR C_YELLOW
			PRINTFORM 一般般!
		CASE IS < 3500
			SETCOLOR C_V_PINK
			PRINTFORM 有点脏!
			CFLAG:LOCAL:信赖度 -= 1
		CASE IS < 5000
			SETCOLOR C_RED
			PRINTFORM 太差了!
			CFLAG:LOCAL:信赖度 -= 5
		CASEELSE
			SETCOLOR C_RED
			PRINTFORM 和猪窝没什么区别!!!
			CFLAG:LOCAL:信赖度 -= 10
	ENDSELECT
			CFLAG:LOCAL:好感度 += (5000 - YOGORE:(LOCAL:1))/100
			RESETCOLOR
IF LOCAL:2 > 0
	PRINTFORML 并交纳了{LOCAL:2}住宿费。
	MONEY += LOCAL:2
	YOGORE:(LOCAL:1) += LOCAL:2
ELSE
	PRINTFORML ,没给钱就走了...甚至把房间弄得更脏了......
	CFLAG:LOCAL:据点来访 = 0	;直接回家了
	YOGORE:(LOCAL:1) += Rand:500 + YOGORE:(LOCAL:1)/10
ENDIF	
		ENDIF
	NEXT
NEXT

LOCAL:4 = Min(来访者数,6)
PRINTFORM 今日来访者住宿人数合计{LOCAL:4,2}人,
$随机住户
IF LOCAL:4 < 1 && 来访者数 > 0
	;PRINTFORMW   大别墅今天好像有新旅客的样子。。。
	PRINTFORMW 预定了大别墅的房间。。。
	RETURN
ELSE
	LOCAL:5 = Rand:(CHARANUM - 2) + 1
	SIF CFLAG:(LOCAL:5):据点来访 == 0 && CFLAG:(LOCAL:5):神社在住 > 57
		GOTO 随机住户
	CFLAG:(LOCAL:5):神社在住 = LOCAL:4 + 60
	CFLAG:(LOCAL:5):初始位置 = LOCAL:4 + 60
	CFLAG:(LOCAL:5):当前位置 = LOCAL:4 + 60
	LOCAL:4 --
	PRINTFORM %NAME_OUTPUT_TRANSLATION("CALLNAME", (LOCAL:5))%.
		GOTO 随机住户
ENDIF

@来访可能(ARG, ARGS)
#FUNCTION
;绝对来访できない判定
SIF CFLAG:ARG:神社在住 > 0
	RETURNF 0
SIF CFLAG:ARG:出禁 || TALENT:ARG:路人
	RETURNF 0
SIF CFLAG:ARG:来访不能
	RETURNF 0
IF GROUPMATCH(ARG, [[若鹭姫]])
	SIF !GETBIT(FLAG:泳池, 3)
		RETURNF 0
ENDIF

;强制ならここで决定
SIF ARGS == "强制"
	RETURNF 1

;モードによる设定
IF FLAG:交流来访模式 == 1
	SIF CFLAG:ARG:好感度 <= 50
		RETURNF 0
ELSEIF FLAG:交流来访模式 == 2
	SIF !TALENT:ARG:思慕 && !IS_LOVER(ARG) && !TALENT:ARG:恋人 && !TALENT:ARG:炮友
		RETURNF 0
ELSEIF FLAG:交流来访模式 == 3
	RETURNF 0
ENDIF
;角色别の设定
SELECTCASE ARG
CASE [[妹红]], [[辉夜]]
	SIF CFLAG:ARG:好感度 <= 500
		RETURNF 0
;绵月、探女は秽れた地上には行きたがらない
CASE [[依姫]], [[丰姫]], [[探女]]
	SIF !TALENT:ARG:恋慕 && !TALENT:ARG:思慕
		RETURNF 0
ENDSELECT

RETURNF 1

@KIKENBIHOUMON
FOR LOCAL, 1, CHARANUM
	IF (TALENT:LOCAL:怀孕愿望 && (!INRANGE(CFLAG:LOCAL:分娩经过日, 1, 59) && (CFLAG:LOCAL:允许无套 == 1 || CFLAG:LOCAL:允许无套 == 2) && ESTRUS_CATEGORY(LOCAL,1)== "危险日" && !CFLAG:LOCAL:妊娠经过日数)) || CFLAG:LOCAL:翌日来访 == 1
		CFLAG:LOCAL:翌日来访 = 1
		;PRINTFORMW 明日%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%が访れる
	ELSE
		CFLAG:LOCAL:翌日来访 = 0
	ENDIF
NEXT
