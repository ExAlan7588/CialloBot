;-------------------------------------------------
;战斗训练
;日常系指令、レベル1
;-------------------------------------------------
@COM411

TFLAG:情绪上升抑制 = 1
;天气を参照
SELECTCASE TIME:5
	CASE 4,6,8,10,12,13
		IF WIND_VELOCITY >= 1
			;(天候パッチ)强风时はヤバい天气
			TFLAG:194 = 2
		ELSE
			;恶劣天气
			TFLAG:194 = 1
		ENDIF
	CASE 5,9,14,15
		;ヤバい天气
		TFLAG:194 = 2
	;それ以外
	CASEELSE
		;(天候パッチ)强风时は恶劣天气
		SIF WIND_VELOCITY == 1
			TFLAG:194 = 1
		;夏场は死ねる
		SIF DAY:2 == 2 && TIME:5 == 1 && TIME > 360 && TIME < 1020
			TFLAG:194 = 3
		;(天候パッチ)暴风时はヤバい天气
		SIF WIND_VELOCITY >= 2
			TFLAG:194 = 2
ENDSELECT
SIF !OUTROOF(CFLAG:MASTER:当前位置)
	TFLAG:194 = 0
SELECTCASE TFLAG:194
	CASE 0
		DOWNBASE:MASTER:体力 = 200
		DOWNBASE:MASTER:气力 = 200
		IF TARGET > 0 && !CFLAG:睡眠
			;固定で获得するソース
			SOURCE:欢乐 = 400
			MAXBASE:TARGET:体力 += RAND:10
			DOWNBASE:TARGET:体力 = 200
			DOWNBASE:TARGET:气力 = 200
			;信赖
			TFLAG:98 += 3
			SIF ABL:MASTER:战斗能力 > 2
			TFLAG:98 ++ 
			IF ABL:MASTER:战斗能力 > ABL:战斗能力
				EXP:战斗经验 += 2
				TFLAG:98 ++ 
			ENDIF
			SIF ABL:MASTER:战斗能力 < ABL:战斗能力 - 2
				EXP:MASTER:战斗经验 ++
			;ABL:亲密をみる
			IF ABL:亲密 <= 5
				SOURCE:欢乐 += 500 + (ABL:亲密 * 60)
				TFLAG:98 ++ 
			ELSEIF ABL:亲密 <= 8
				SOURCE:欢乐 += 750 + (ABL:亲密 * 75)
			ELSEIF ABL:亲密 <= 11
				SOURCE:欢乐 += 1000 + (ABL:亲密 * 75)
			ELSE
				SOURCE:欢乐 += 2000 + (ABL:亲密 * 30)
			ENDIF
			;好感度をみる
			IF CFLAG:2 <= 500
				SOURCE:欢乐 += CFLAG:2
			ELSEIF CFLAG:2 <= 5000
				SOURCE:欢乐 += 500 + (CFLAG:2 - 500) / 3
			ELSE
				SOURCE:欢乐 += 2000 + (CFLAG:2 - 5000) / 5
			ENDIF
			SIF SOURCE:欢乐 < 0
				SOURCE:欢乐 = 0
			EXP:MASTER:战斗经验 ++
			EXP:战斗经验 ++
		ENDIF
	CASE 1
	;恶劣天气
	DOWNBASE:MASTER:体力 = 300
	DOWNBASE:MASTER:气力 = 300
	IF TARGET > 0 && !CFLAG:睡眠
		;固定で获得するソース
		SOURCE:欢乐 = 450
		MAXBASE:TARGET:体力  += RAND:15
		MAXBASE:TARGET:气力  += RAND:10
		DOWNBASE:TARGET:体力 = 300
		DOWNBASE:TARGET:气力 = 300
		;信赖
		TFLAG:98 += 3
		SIF ABL:MASTER:战斗能力 > 2
		TFLAG:98 ++ 
		IF ABL:MASTER:战斗能力 > ABL:战斗能力
			EXP:战斗经验 += 2
			TFLAG:98 ++ 
		ENDIF
		SIF ABL:MASTER:战斗能力 < ABL:战斗能力 - 2
			EXP:MASTER:战斗经验 ++
		;ABL:亲密をみる
		IF ABL:亲密 <= 5
			SOURCE:欢乐 += 520 + (ABL:亲密 * 60)
			TFLAG:98 ++ 
		ELSEIF ABL:亲密 <= 8
			SOURCE:欢乐 += 750 + (ABL:亲密 * 75)
		ELSEIF ABL:亲密 <= 11
			SOURCE:欢乐 += 1100 + (ABL:亲密 * 75)
		ELSE
			SOURCE:欢乐 += 2150 + (ABL:亲密 * 30)
		ENDIF

		;好感度をみる
		IF CFLAG:2 <= 500
			SOURCE:欢乐 += CFLAG:2
		ELSEIF CFLAG:2 <= 5000
			SOURCE:欢乐 += 500 + (CFLAG:2 - 500) / 3
		ELSE
			SOURCE:欢乐 += 2000 + (CFLAG:2 - 5000) / 5
		ENDIF
		SIF SOURCE:欢乐 < 0
			SOURCE:欢乐 = 0
		EXP:MASTER:战斗经验 += 2
		EXP:战斗经验 += 2
	ENDIF
	CASE 2,3
	;ヤバい天气
		DOWNBASE:MASTER:体力 = 600
		DOWNBASE:MASTER:气力 = 600
		IF TARGET > 0 && !CFLAG:睡眠
			;固定で获得するソース
			SOURCE:欢乐 = 500
			MAXBASE:TARGET:体力 += RAND:30
			MAXBASE:TARGET:气力 += RAND:30
			DOWNBASE:TARGET:体力 = 600
			DOWNBASE:TARGET:气力 = 600
			;信赖
			TFLAG:98 += 3
			SIF ABL:MASTER:战斗能力 > 2
			TFLAG:98 ++ 
			IF ABL:MASTER:战斗能力 > ABL:战斗能力
				EXP:战斗经验 += 2
				TFLAG:98 ++ 
			ENDIF
			SIF ABL:MASTER:战斗能力 < ABL:战斗能力 - 2
				EXP:MASTER:战斗经验 ++
			;ABL:亲密をみる
			IF ABL:亲密 <= 5
				TFLAG:98 ++ 
				SOURCE:欢乐 += 550 + (ABL:亲密 * 60)
			ELSEIF ABL:亲密 <= 8
				SOURCE:欢乐 += 800 + (ABL:亲密 * 75)
			ELSEIF ABL:亲密 <= 11
				SOURCE:欢乐 += 1200 + (ABL:亲密 * 75)
			ELSE
				SOURCE:欢乐 += 2300 + (ABL:亲密 * 30)
			ENDIF
			;好感度をみる
			IF CFLAG:2 <= 500
				SOURCE:欢乐 += CFLAG:2
			ELSEIF CFLAG:2 <= 5000
				SOURCE:欢乐 += 500 + (CFLAG:2 - 500) / 3
			ELSE
				SOURCE:欢乐 += 2000 + (CFLAG:2 - 5000) / 5
			ENDIF
			SIF SOURCE:欢乐 < 0
				SOURCE:欢乐 = 0
			EXP:MASTER:战斗经验 += 3
			EXP:战斗经验 += 3
		ENDIF
ENDSELECT
TIME += 60
	SIF CFLAG:同行
		CFLAG:同行 += 60
EXP:MASTER:战斗经验 ++
TCVAR:MASTER:空腹时刻 -= 15
IF TARGET
	TCVAR:TARGET:空腹时刻 -= 15
	CALL ADD_TIRED(TARGET, POWER(TFLAG:194 + 1, 3) * 100)
ENDIF
SIF ITEM:101 && !RAND:2
	EXP:MASTER:战斗经验 ++
IF ITEM:运动饮料
	IF TFLAG:194 == 3
		DOWNBASE:MASTER:体力 -= 200
		DOWNBASE:MASTER:气力 -= 300
	ELSE
		DOWNBASE:MASTER:体力 -= 50
		DOWNBASE:MASTER:气力 -= 50
	ENDIF
	SIF TARGET
		SOURCE:欢乐 += 300
	TFLAG:193 = 1
ENDIF
RETURN 1

;-------------------------------------------------
;实行判定
;-------------------------------------------------
@COM_ABLE411
;战斗训练实行判定
SIF !TFLAG:100
	RETURN 0
;批量管理
SIF GLOBAL_COMABLE(411)
	RETURN RESULT
;停止中は不可
SIF FLAG:70 == 1
	RETURN 0
;仕事中
SIF CFLAG:行动 == 5
	RETURN 0
SIF !战斗训练可(CFLAG:MASTER:当前位置)
	RETURN 0
;气力0
SIF BASE:MASTER:气力 <= 0
	RETURN 0
SIF CFLAG:诶嘿嘿 == 2
	RETURN 0
RETURN 1

