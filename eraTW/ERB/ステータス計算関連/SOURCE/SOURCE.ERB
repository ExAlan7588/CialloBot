@SOURCE_CHECK
#DIM 吻痕反感
#DIM 欲求不满度上升
#DIM 经验增加量
#DIM 体位保存
#DIM Ｖ性交保存
#DIM Ａ性交保存
#DIM PLAYER体位保存
#DIM PLAYERＶ性交保存
#DIM PLAYERＡ性交保存
#DIMS ゴム 
#DIM 中毒补正
VARSET LOCAL
SELECTCOM = TFLAG:3
中毒补正 = 0
ゴム =
;调教SELECTCOMの时间经过
CALL TRACHECK_TIME

;-------------------------------------------------
;身体接触の继续、解除
;-------------------------------------------------
CALL TOUCH_SUCCESSION(TARGET)

;-------------------------------------------------
;TRYCALLFORM TOUCH_SUCCESSION_{SELECTCOM}(TARGET)
;TOUCH_SUCCESSIONで行っている处理を各指令ファイルに分散させることで、指令追加を容易にしたい
;-------------------------------------------------

IF !Counter不发指令(SELECTCOM)
	;Counter
	FOR LOCAL, 1, GET_TARGETNUM() + 1
		SIF TARGET:LOCAL <= 0
			CONTINUE
		CALL EVENT_COUNTER(TARGET:LOCAL,LOCAL)
		CALL EVENT_COUNTER_SOURCE(TARGET:LOCAL,LOCAL)
	NEXT
	;CALL EVENT_COUNTER_COMBINATION
ENDIF
FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:当前位置 != CFLAG:MASTER:当前位置
		CONTINUE
	;性交フラグの设定
	IF TEQUIP:LOCAL:Ｖ接触部位 == 1
		TEQUIP:LOCAL:50 = MASTER
	ELSE
		TEQUIP:LOCAL:50 = -1
	ENDIF
	IF TEQUIP:LOCAL:Ａ接触部位 == 1
		TEQUIP:LOCAL:51 = MASTER
	ELSE
		TEQUIP:LOCAL:51 = -1
	ENDIF
	IF TEQUIP:LOCAL:Ｐ接触部位 == 6
		TEQUIP:PLAYER:50 = LOCAL
	ELSE
		TEQUIP:PLAYER:50 = -1
	ENDIF
	IF TEQUIP:LOCAL:Ｐ接触部位 == 7
		TEQUIP:PLAYER:51 = LOCAL
	ELSE
		TEQUIP:PLAYER:51 = -1
	ENDIF
NEXT

FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:当前位置 != CFLAG:MASTER:当前位置
		CONTINUE
	;Ｐが入ってないなら体位リセット
	IF TEQUIP:LOCAL:50 < 0 && TEQUIP:LOCAL:51 < 0
		TEQUIP:LOCAL:体位 = 0
	;Ｖ性交中かつ前回Ｖ性交ならTEQUIPは复归
	ELSEIF TEQUIP:LOCAL:50 >= 0 && TEQUIP:LOCAL:116
		SIF TEQUIP:LOCAL:116 != 3	;指插入でない场合のみ适用
			TEQUIP:LOCAL:106 = TEQUIP:LOCAL:116
	;Ａ性交中かつ前回Ａ性交ならTEQUIPは复归
	ELSEIF TEQUIP:LOCAL:51 >= 0 && TEQUIP:LOCAL:117
		SIF TEQUIP:LOCAL:117 != 3	;指插入でない场合のみ适用
			TEQUIP:LOCAL:107 = TEQUIP:LOCAL:117
	ENDIF
	;ついでに勃起度の保存
	CFLAG:LOCAL:勃起度 = BASE:LOCAL:勃起
NEXT
;-------------------------------------------------
;Counter脱衣の实处理
;-------------------------------------------------
CALL DATUI_LATE

;-------------------------------------------------
;@COMの呼び出し
;-------------------------------------------------
;TARGETごとにCOMF呼出
CALL CALL_COM(TARGET)

体位保存 = TEQUIP:体位
Ｖ性交保存 = TEQUIP:Ｖ性交
Ａ性交保存 = TEQUIP:Ａ性交
PLAYER体位保存 = TEQUIP:MASTER:体位
PLAYERＶ性交保存 = TEQUIP:PLAYER:Ｖ性交
PLAYERＡ性交保存 = TEQUIP:PLAYER:Ａ性交
TFLAG:前回の指令结果 = RESULT
;RESULTが－1なら中止判定
SIF TFLAG:前回の指令结果 < 0
	RETURN 0
;RESULTが0ならSOURCE计算SKIP
SIF !TFLAG:前回の指令结果
	GOTO SOURCE_SKIP
;口上内でソースを追加する处理
CALL KOJO_MESSAGE_SEND("EXTRASOURCE", SELECTCOM, TARGET)

IF OAZUKE(TARGET)
	PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%对“还不能去”的指令表示了不满…
	SOURCE:反感 += 3000
	SOURCE:屈从 += 500
	SOURCE:恭顺 -= 1500
ENDIF

CALL PEARL_CHK_MASTER

FOR LOCAL,0,CHARANUM
	吻痕反感 = 0
	SIF CFLAG:LOCAL:当前位置 == SUKIMA()
		CONTINUE
	;跳蛋插入
	IF CFLAG:LOCAL:跳蛋插入
		SOURCE:LOCAL:快Ｖ += TIME_PROGRESS(TIME:1) * 10
		CFLAG:LOCAL:跳蛋插入 = MAX(CFLAG:LOCAL:跳蛋插入 - TIME_PROGRESS(TIME:1),0)
		IF CFLAG:LOCAL:跳蛋插入 == 0
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%装备着的跳蛋的电池没电了
			IF TALENT:LOCAL:处女 < 1
				EXP:LOCAL:Ｖ经验 += 9
			ELSE
				TFLAG:2 = 1
			ENDIF
		ENDIF
	ENDIF
	IF CFLAG:LOCAL:跳蛋A插入
		SOURCE:LOCAL:快Ａ += TIME_PROGRESS(TIME:1) * 10
		CFLAG:LOCAL:跳蛋A插入 = MAX(CFLAG:LOCAL:跳蛋A插入 - TIME_PROGRESS(TIME:1),0)
		IF CFLAG:LOCAL:跳蛋A插入 == 0
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%装备着的跳蛋的电池没电了
			EXP:LOCAL:Ａ经验 += 9
		ENDIF
	ENDIF
	IF TFLAG:吻痕 && LOCAL > 0 && !TFLAG:绷带 && !FLAG:70 && !CFLAG:LOCAL:睡眠
		IF CFLAG:LOCAL:当前位置 == CFLAG:MASTER:当前位置 && TFLAG:吻痕 != LOCAL && !TFLAG:泡澡堂
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%看到%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的吻痕后怪责了起来……
			IF TALENT:LOCAL:恋慕
				吻痕反感 = 500
			ELSEIF TALENT:LOCAL:思慕
				吻痕反感 = 300
			ENDIF
			吻痕反感 = 吻痕反感 * (TALENT:LOCAL:贞操 + 2) / 2
			SOURCE:LOCAL:反感 += 吻痕反感
		ENDIF
	ENDIF
;没穿と露出が增加
	SIF !EQUIP:LOCAL:下半身内衣１ && !EQUIP:LOCAL:下半身内衣２ && !TALENT:LOCAL:淫乱
		SOURCE:LOCAL:露出 += TIME_PROGRESS(TIME:1)

	SIF IsInsenceValid(LOCAL) || IsGardenValid(LOCAL)
		SOURCE:LOCAL:情欲 += TIME_PROGRESS(TIME:1) * (RAND:((ABL:LOCAL:欲望) + 1) + 3)

	SIF TEQUIP:LOCAL:吸乳头
		CALL EQUIP_COM11(LOCAL)
	SIF TEQUIP:LOCAL:揉胸
		CALL EQUIP_COM12(LOCAL)
	SIF TEQUIP:LOCAL:继续接吻
		CALL EQUIP_COM19(LOCAL)
	;装着系は后で考える
	SIF LOCAL > 0 && !CFLAG:LOCAL:同室
		CONTINUE
	;-------------------------------------------------
	;主人、同性、调教者の能力の处理
	;-------------------------------------------------
	CALL SOURCE_SEX_CHECK(LOCAL)
	CALL PLAYER_SKILL_CHECK(LOCAL)

	;-------------------------------------------------
	;技巧、好感度、情绪、理性のチェック
	;-------------------------------------------------
	FOR LOCAL:1,0,100
		SOURCE:LOCAL:(LOCAL:1) = SOURCE:LOCAL:(LOCAL:1) *  MASTER_FAVOR_CHECK(LOCAL,LOCAL:1) * TECHNIQUE_CHECK(LOCAL,LOCAL:1) / 10000
		SOURCE:LOCAL:(LOCAL:1) = SOURCE:LOCAL:(LOCAL:1) *  MOOD_CHECK(LOCAL,LOCAL:1) * REASON_CHECK(LOCAL,LOCAL:1) / 10000
	NEXT

	;-------------------------------------------------
	;中毒充足のチェック
	;-------------------------------------------------
	;自慰中毒
	IF EXP_UP(22,LOCAL)
		FOR LOCAL:1,0,100
			;快感,性行动,情欲,恭顺,露出,屈从
			SIF (LOCAL:1 >= 0 && LOCAL:1 <= 9) || LOCAL:1 == 11 || (LOCAL:1 >= 15 && LOCAL:1 <= 18) 
				SOURCE:LOCAL:(LOCAL:1) = SOURCE:LOCAL:(LOCAL:1) * (100 + GET_REVISION(ABL:LOCAL:自慰中毒, 500, 15)) / 100
		NEXT
	ENDIF
	;-------------------------------------------------
	;振动棒など付けっぱ无道具のチェック
	;-------------------------------------------------
	CALL EQUIP_CHECK(LOCAL)
	;-------------------------------------------------
	;経験加算
	;-------------------------------------------------
	CALL SOURCE_EXP(LOCAL)
	;-------------------------------------------------
	;处女,童贞丧失の处理
	;-------------------------------------------------
	CALL LOST_VIRGIN(LOCAL)
	CALL 童贞无接吻经验丧失(LOCAL)
	;-------------------------------------------------
	;快Ｃのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｃ(LOCAL)
	;-------------------------------------------------
	;快Ｖのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｖ(LOCAL)
	;-------------------------------------------------
	;快Ａのソース
	;-------------------------------------------------
	CALL SOURCE_快Ａ(LOCAL)
	;-------------------------------------------------
	;快Ｂのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｂ(LOCAL)
	;-------------------------------------------------
	;-------------------------------------------------
	;快Ｍのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｍ(LOCAL)
	;-------------------------------------------------
	;与快Ｃのソース
	;-------------------------------------------------
	SIF !(TALENT:PLAYER:2 & 2)
	CALL SOURCE_与快Ｃ(LOCAL)
	;-------------------------------------------------
	;与快Ｖのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ｖ(LOCAL)
	;-------------------------------------------------
	;与快Ａのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ａ(LOCAL)
	;-------------------------------------------------
	;与快Ｂのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ｂ(LOCAL)
	;-------------------------------------------------
	;与快Ｍのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ｍ(LOCAL)
	;-------------------------------------------------
NEXT

;-------------------------------------------------
;同じ指令の连续实行による上下の处理（快乐系）
;-------------------------------------------------
IF SELECTCOM == PREVCOM && TFLAG:50 == TFLAG:151 && (SELECTCOM < 350 || SELECTCOM >= 500) && 连续实行()
	;UP:0,1,2,3は绝顶に络むので先に处理してある
	CUP:TARGET:快Ｃ /= 2
	CUP:TARGET:快Ｖ /= 2
	CUP:TARGET:快Ａ /= 2
	CUP:TARGET:快Ｂ /= 2
	CUP:TARGET:快Ｍ /= 2
ENDIF
IF TCVAR:TARGET:强行
	TIMES CUP:TARGET:快Ｃ, 0.75
	TIMES CUP:TARGET:快Ｖ, 0.75
	TIMES CUP:TARGET:快Ａ, 0.75
	TIMES CUP:TARGET:快Ｂ, 0.75
	TIMES CUP:TARGET:快Ｍ, 0.75
ENDIF
IF TEQUIP:TARGET:挑逗模式
	TIMES CUP:TARGET:快Ｃ, 0.90
	TIMES CUP:TARGET:快Ｖ, 0.90
	TIMES CUP:TARGET:快Ａ, 0.90
	TIMES CUP:TARGET:快Ｂ, 0.90
	TIMES CUP:TARGET:快Ｍ, 0.90
ENDIF
IF TCVAR:TARGET:烂醉
	TIMES CUP:TARGET:快Ｃ, 0.70
	TIMES CUP:TARGET:快Ｖ, 0.70
	TIMES CUP:TARGET:快Ａ, 0.70
	TIMES CUP:TARGET:快Ｂ, 0.70
	TIMES CUP:TARGET:快Ｍ, 0.70
ENDIF

FOR LOCAL,0,CHARANUM
	;装着系は后で考える
	SIF LOCAL > 0 && !CFLAG:LOCAL:同室
		CONTINUE
	;其他系ソース计算处理
	CALL SOURCE_CVAB_EXTRA(LOCAL)
	
	BASE:LOCAL:勃起 = BASE:LOCAL:勃起 + CUP:LOCAL:快Ｃ / 5 + CUP:LOCAL:快Ｖ / 10 + CUP:LOCAL:快Ａ / 10 + CUP:LOCAL:快Ｂ / 10
	;-------------------------------------------------
	;绝顶处理
	;-------------------------------------------------
	CALL ORGASM_ADD(LOCAL)
NEXT

;-------------------------------------------------
;射精チェック（扶她・男人）
;-------------------------------------------------
;要検讨
CALL EVENT_SHOOT

FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:当前位置 == SUKIMA()
		CONTINUE
	;装着系は后で考える
	IF LOCAL > 0 && !CFLAG:LOCAL:同室
		SIF IsGardenValid(LOCAL)
			CALL SOURCE_情欲(LOCAL)
		CONTINUE
	ENDIF
	;-------------------------------------------------
	;调教对象の喷乳チェック
	;-------------------------------------------------
	CALL TARGET_MILK_CHECK(LOCAL)
	;-------------------------------------------------
	;睡奸からの复归前处理
	;-------------------------------------------------
	CALL DRUNK_RECOVER_BEFORE(TARGET)
	;-------------------------------------------------
	;情爱のソース
	;-------------------------------------------------
	CALL SOURCE_情爱(LOCAL)
	;-------------------------------------------------
	;性行动のソース
	;-------------------------------------------------
	CALL SOURCE_性行动(LOCAL)
	;-------------------------------------------------
	;达成のソース
	;-------------------------------------------------
	CALL SOURCE_达成(LOCAL)
	;-------------------------------------------------
	;痛みのソース
	;-------------------------------------------------
	CALL SOURCE_苦痛(LOCAL)
	;-------------------------------------------------
	;恐れのソース
	;-------------------------------------------------
	CALL SOURCE_恐怖(LOCAL)
	;-------------------------------------------------
	;液体のソース
	;-------------------------------------------------
	CALL SOURCE_液体(LOCAL)
	;-------------------------------------------------
	;情欲のソース
	;-------------------------------------------------
	CALL SOURCE_情欲(LOCAL)
	;-------------------------------------------------
	;恭顺のソース
	;-------------------------------------------------
	CALL SOURCE_恭顺(LOCAL)
	;-------------------------------------------------
	;露出のソース
	;-------------------------------------------------
	CALL SOURCE_露出(LOCAL)
	;-------------------------------------------------
	;屈从のソース
	;-------------------------------------------------
	CALL SOURCE_屈从(LOCAL)
	
	;-------------------------------------------------
	;欢乐のソース
	;-------------------------------------------------
	CALL SOURCE_欢乐(LOCAL)
	;-------------------------------------------------
	;征服のソース
	;-------------------------------------------------
	CALL SOURCE_征服(LOCAL)
	;-------------------------------------------------
	;被动のソース
	;-------------------------------------------------
	CALL SOURCE_被动(LOCAL)
	;-------------------------------------------------
	;诱惑のソース
	;-------------------------------------------------
	CALL SOURCE_诱惑(LOCAL)
	;-------------------------------------------------
	;侮辱のソース
	;-------------------------------------------------
	CALL SOURCE_侮辱(LOCAL)
	;-------------------------------------------------
	;挑衅のソース
	;-------------------------------------------------
	CALL SOURCE_挑衅(LOCAL)
	;-------------------------------------------------
	;侍奉のソース
	;-------------------------------------------------
	CALL SOURCE_侍奉(LOCAL)
	;-------------------------------------------------
	;强迫のソース
	;-------------------------------------------------
	CALL SOURCE_强迫(LOCAL)
	;-------------------------------------------------
	;施虐のソース
	;-------------------------------------------------
	CALL SOURCE_施虐(LOCAL)
	
	;-------------------------------------------------
	;不洁のソース
	;-------------------------------------------------
	CALL SOURCE_不洁(LOCAL)
	;-------------------------------------------------
	;郁闷のソース
	;-------------------------------------------------
	CALL SOURCE_郁闷(LOCAL)
	;-------------------------------------------------
	;偏离正轨のソース
	;-------------------------------------------------
	CALL SOURCE_偏离正轨(LOCAL)
	;-------------------------------------------------
	;反感のソース
	;-------------------------------------------------
	CALL SOURCE_反感(LOCAL)
	;-------------------------------------------------
	;素質などによる上下の处理
	;-------------------------------------------------
	CALL SOURCE_EXTRA(LOCAL)
	;-------------------------------------------------
	;睡眠深度の减少处理
	;-------------------------------------------------
	CALL 睡眠深度减少(LOCAL)

	;魔改五重绝顶魔法，魔力印记现在防止过度增加不快，以免EX模式出现反抗，防止过度痛苦直接体力见底。
	IF SOURCE:TARGET:魔力印记 == 1
		CUP:LOCAL:情欲 /= FLAG:魔法强度
		CUP:LOCAL:不快 /= FLAG:魔法强度
		DOWNBASE:LOCAL:体力 /= FLAG:魔法强度
		DOWNBASE:LOCAL:气力 /= FLAG:魔法强度
	ENDIF
NEXT
;-------------------------------------------------
;同じ指令の连续实行による上下の处理
;-------------------------------------------------
IF SELECTCOM == PREVCOM && TFLAG:50 == TFLAG:151 && (SELECTCOM < 350 || SELECTCOM >= 500) && 连续实行()
	;UP:0,1,2は绝顶に络むので先に处理してある
	UP:情欲 /= 2
	UP:恭顺 /= 2
	UP:屈服 /= 2
	UP:习得 /= 2
	UP:羞耻 /= 2
	UP:恐怖 /= 2
	UP:苦痛 /= 2
	UP:好意 /= 2
	UP:优越 /= 2
ENDIF

LOCAL:1 = 0
FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:当前位置 == SUKIMA()
		CONTINUE
	LOCAL:1 += CUP:LOCAL:情欲 / 5
	LOCAL:1 += MAX(5,(ABL:LOCAL:受虐属性 - 3)) * (CUP:LOCAL:苦痛 + CUP:LOCAL:苦痛) / 2
	LOCAL:1 += MAX(5,(ABL:LOCAL:受虐属性 - 1)) * CUP:LOCAL:羞耻 / 2
	LOCAL:1 = MIN(500,LOCAL:1)
	BASE:LOCAL:勃起 = BASE:LOCAL:勃起 + LOCAL:1
	;装着系は后で考える
	SIF LOCAL > 0 && !CFLAG:LOCAL:同室
		CONTINUE
	;-------------------------------------------------
	;体力・气力の减少
	;-------------------------------------------------
	IF WEATHERDLC
		IF TIME:5 == 7
			IF LOCAL != 0 && TFLAG:50 == TFLAG:151 && (SELECTCOM < 350 || SELECTCOM >= 500)
				DOWNBASE:LOCAL:气力 -= DOWNBASE:LOCAL:气力 * 2
				DOWNBASE:LOCAL:体力 -= DOWNBASE:LOCAL:体力 * 2
			ENDIF
		ELSEIF TIME:5 == 9
			DOWNBASE:LOCAL:体力 = ( DOWNBASE:LOCAL:体力 * 3 ) / 2
		ELSEIF TIME:5 == 14
			DOWNBASE:LOCAL:体力 = DOWNBASE:LOCAL:体力 / 2
		ENDIF
	ENDIF

	CALL SOURCE_DOWNBASE(LOCAL)
	;-------------------------------------------------
	;苦痛快乐经验、侍奉快乐经验のチェック
	;-------------------------------------------------
	CALL EXP_GOT_CHECK(LOCAL)
NEXT

$SOURCE_SKIP
;-------------------------------------------------
;调教口上
;-------------------------------------------------
;CALL KOJO_MESSAGE_COM
;VARSET DOUBLE_MESSAGE_BLOCKED
;TFLAG:SKIPASSIKOJO = 0
CALL KOJO_MESSAGE_SEND("COMMAND",-1,TARGET,-1,-1)
SIF !TFLAG:SKIPASSIKOJO
	CALL SEND_ASSISTANT_KOJO
;插绘　正面系　ゴムありの射精时、体位もなくなるのはどうしてだ
IF Ｖ性交保存 != -1 && GROUPMATCH(体位保存,1,2,3,4,5) && !FLAG:插入アニメ过滤器 & アニメ过滤器_插入
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE 体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("正常位_插入")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("后背位_插入")
	ENDSELECT
ENDIF

IF PLAYERＶ性交保存 != -1 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5) && !FLAG:插入アニメ过滤器 & アニメ过滤器_插入
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE PLAYER体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("正常位_插入")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("后背位_插入")
	ENDSELECT
ENDIF

IF Ａ性交保存 != -1 && GROUPMATCH(体位保存,1,2,3,4,5) && !FLAG:插入アニメ过滤器 & アニメ过滤器_插入
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE 体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("Ａ正常位_插入")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("Ａ后背位_插入")
	ENDSELECT
ENDIF
IF PLAYERＡ性交保存 != -1 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5) && !FLAG:插入アニメ过滤器 & アニメ过滤器_插入
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE PLAYER体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("Ａ正常位_插入" )
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("Ａ后背位_插入" )
	ENDSELECT
ENDIF

SIF FLAG:走光CT > 0
	FLAG:走光CT -= 1
SIF FLAG:走光发生
	CALL WINDY_PANCHIRA
;手淫/手淫する/手淫フェラ*2021/10/11新增*
IF TEQUIP:TARGET:指接触部位 == 1 || TEQUIP:TARGET:Ｐ接触部位 == 3
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF TEQUIP:TARGET:口２ == 1
			CALL PRINT_IMAGE_ANIMATION_手淫("手淫_插入" )
			CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_插入" )
		ELSE
			CALL PRINT_IMAGE_ANIMATION_手淫("手淫_插入" )
		ENDIF
ENDIF

;フェラチオ/手淫フェラ/フェラする*2021/10/11新增*
IF TEQUIP:TARGET:口接触部位 == 1
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF ABL:TARGET:精液中毒 > 4
			IF RAND:3 == 0
				CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_插入" )
			ELSEIF RAND:2 == 0
				CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_插入" )
			ELSE
				CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_插入" )
			ENDIF
		ELSEIF ABL:TARGET:精液中毒 < 1 || TEQUIP:TARGET:指２ == 1
			CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_插入" )
		ELSE
			IF RAND:2 == 0
				CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_插入" )
			ELSE
				CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_插入" )
			ENDIF
		ENDIF
ELSEIF TEQUIP:TARGET:Ｐ接触部位 == 4
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF ABL:PLAYER:精液中毒 > 4
			IF RAND:3 == 0
				CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_插入" )
			ELSEIF RAND:2 == 0
				CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_插入" )
			ELSE
				CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_插入" )
			ENDIF
		ELSEIF ABL:PLAYER:精液中毒 < 1
			CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_插入" )
		ELSE
			IF RAND:2 == 0
				CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_插入" )
			ELSE
				CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_插入" )
			ENDIF
		ENDIF
ENDIF

;足コキ/足コキする*2021/10/29新增*
IF TEQUIP:TARGET:足接触部位 == 1
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF RAND:2 == 0
			CALL PRINT_IMAGE_ANIMATION_足コキ("足コキ_插入" )
		ELSE
			CALL PRINT_IMAGE_ANIMATION_足コキ2("足コキ2_插入" )
		ENDIF
ELSEIF TEQUIP:TARGET:Ｐ接触部位 == 8
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF RAND:2 == 0
			CALL PRINT_IMAGE_ANIMATION_足コキ("足コキ_插入" )
		ELSE
			CALL PRINT_IMAGE_ANIMATION_足コキ2("足コキ2_插入" )
		ENDIF
ENDIF
;Counter
IF TARGET
	LOCAL:4 = TARGET
	DRAWLINE
	FOR LOCAL, 1, GET_TARGETNUM() + 1
		SIF TCVAR:(TARGET:LOCAL):30 > 1
			CONTINUE
		SIF TARGET:LOCAL <= 0
			CONTINUE
		; CALL EVENT_COUNTER(TARGET:LOCAL,LOCAL)
		; CALL EVENT_COUNTER_SOURCE(TARGET:LOCAL,LOCAL)
		SIF TCVAR:(TARGET:LOCAL):20 && TFLAG:193 != 99 && !CFLAG:TARGET:陪睡中
			CALL KOJO_MESSAGE_SEND("COUNTER",2,TARGET:LOCAL,0,0)
	NEXT
	TARGET = LOCAL:4
ENDIF

;-------------------------------------------------
;睡奸からの复归处理
;-------------------------------------------------
CALL DRUNK_RECOVER(TARGET)

;-------------------------------------------------
;EXP取得表示
;-------------------------------------------------
LOCAL:2 = 0
LOCAL:3 = 0
;---------------
LOCAL:9 = 0
;---------------
FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:当前位置 != CFLAG:MASTER:当前位置
		CONTINUE
	SIF TCVAR:LOCAL:缩略显示
		CONTINUE
	FOR LOCAL:1,0,100
		IF EXP_UP(LOCAL:1,LOCAL)
			经验增加量 = EXP_UP(LOCAL:1,LOCAL)
			LOCAL:2 ++
			LOCAL:3 ++
			SIF LOCAL:2 == 1
				PRINTL
			IF LOCAL:1 == FLAG:加护 && FLAG:加护 && LOCAL == MASTER
				EXP:MASTER:(LOCAL:1) ++
				经验增加量 ++
			ENDIF
			PRINTFORM %EXP_TR(LOCAL:1)% +{经验增加量}(%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%)
			CALL Qol_SkillProgressBar(LOCAL, LOCAL:1)
			PRINTL
			;你は无自觉经验を得ないように
			IF LOCAL:1 >= 0 && LOCAL:1 <= 3 && LOCAL && (FLAG:70 || CFLAG:恶作剧)
				EXP:LOCAL:((LOCAL:1) + 60) += 1
			ENDIF
		ENDIF
	NEXT
	LOCAL:2 = 0
NEXT
SIF LOCAL:3
	WAIT
;-------------------------------------------------
;ABLUP
;-------------------------------------------------
IF !FLAG:ABLUP省略
	FOR LOCAL,0,CHARANUM
		SIF CFLAG:LOCAL:当前位置 != CFLAG:MASTER:当前位置
			CONTINUE
		SIF TCVAR:LOCAL:缩略显示
			CONTINUE
		CALL SOURCE_ABLUP(LOCAL)
	NEXT
ENDIF
;-------------------------------------------------
;触手の射精时の口上
;-------------------------------------------------
;DEBUG	CALL KOJO_MESSAGE_PALAMCNG_E
CALL KOJO_MESSAGE_SEND("PALAM",5,TARGET,-1,-1)
;-------------------------------------------------
;奴隷の绝顶时の口上
;-------------------------------------------------
;CALL MESSAGE_PALAMCNG_B2

CALL KOJO_MESSAGE_SEND("PALAM",2,TARGET,-1,-1)
;插绘　插入∨绝顶
IF NOWEX:Ｖ绝顶 && Ｖ性交保存 != -1 && GROUPMATCH(体位保存,1,2,3,4,5)
	IF !GETBIT(TCVAR:50,1)
		SELECTCASE 体位保存
			CASE 1,3,4
				CALL PRINT_IMAGE_ANIMATION_正常位("正常位_绝顶")
			CASE 2,5
				CALL PRINT_IMAGE_ANIMATION_后背位("后背位_绝顶")
		ENDSELECT
	ENDIF
ENDIF
IF NOWEX:Ａ绝顶 && Ａ性交保存 != -1 && GROUPMATCH(体位保存,1,2,3,4,5)
	IF !GETBIT(TCVAR:50,2)
		SELECTCASE 体位保存
			CASE 1,3,4
				CALL PRINT_IMAGE_ANIMATION_正常位("Ａ正常位_绝顶")
			CASE 2,5
				CALL PRINT_IMAGE_ANIMATION_后背位("Ａ后背位_绝顶")
		ENDSELECT
	ENDIF
ENDIF


;插绘　PALYER插入∨绝顶
IF NOWEX:MASTER:Ｖ绝顶 && PLAYERＶ性交保存 != -1 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5)
	IF NOWEX:TARGET:射精 == 0
		SELECTCASE PLAYER体位保存
			CASE 1,3,4
				CALL PRINT_IMAGE_ANIMATION_正常位("正常位_绝顶")
			CASE 2,5
				CALL PRINT_IMAGE_ANIMATION_后背位("后背位_绝顶")
		ENDSELECT
	ENDIF
ENDIF
IF NOWEX:MASTER:Ａ绝顶 && PLAYERＡ性交保存 != -1 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5)
	IF NOWEX:TARGET:射精 == 0
		SELECTCASE PLAYER体位保存
			CASE 1,3,4
				CALL PRINT_IMAGE_ANIMATION_正常位("Ａ正常位_绝顶")
			CASE 2,5
				CALL PRINT_IMAGE_ANIMATION_后背位("Ａ后背位_绝顶")
		ENDSELECT
	ENDIF
ENDIF
;DEBUG	CALL KOJO_MESSAGE_PALAMCNG_B


;-------------------------------------------------
;奴隷の挑逗时の口上
;-------------------------------------------------
IF (EX:TARGET:Ｃ寸止 + EX:TARGET:Ｖ寸止 + EX:TARGET:Ａ寸止 + EX:TARGET:Ｍ寸止 + EX:TARGET:Ｂ寸止) > 0 && TEQUIP:TARGET:挑逗模式
	CALL KOJO_MESSAGE_SEND("PALAM",6,TARGET,-1,-1)
	;ウフフ时系装备リセット
	FOR LOCAL,10, 80
		SELECTCASE LOCAL
			CASE 18 TO 20, 25 TO 40, 49 TO 51
				CONTINUE
		ENDSELECT
		TEQUIP:TARGET:LOCAL = 0
	NEXT
ENDIF
;-------------------------------------------------
;调教者の射精时の口上
;-------------------------------------------------
CALL 射精绝顶表记(MASTER)
CALL 射精绝顶表记(TARGET)
CALL MESSAGE_PALAMCNG_B2

;DEBUG	CALL KOJO_MESSAGE_PALAMCNG_A
CALL KOJO_MESSAGE_SEND("PALAM",1,TARGET,-1,-1)

;插绘　插入射精　正常位系列
IF GETBIT(TCVAR:50,1) && TEQUIP:Ｖ性交 != -1 && !TCVAR:PLAYER:避孕套 && GROUPMATCH(体位保存,1,2,3,4,5)
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE 体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("正常位_射精")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("后背位_射精")
	ENDSELECT
ENDIF
IF GETBIT(TCVAR:50,2) && TEQUIP:Ａ性交 != -1 && !TCVAR:PLAYER:避孕套 && GROUPMATCH(体位保存,1,2,3,4,5)
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE 体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("Ａ正常位_射精")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("Ａ后背位_射精")
	ENDSELECT
ENDIF

;插绘　插入射精
;相手が避孕套付けることあるのかな？
IF NOWEX:TARGET:射精 > 0 && PLAYERＶ性交保存 != -1 && !TCVAR:TARGET:避孕套 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5)
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE PLAYER体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("正常位_射精")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("后背位_射精", 1)
	ENDSELECT
ENDIF
IF NOWEX:TARGET:射精 > 0 && PLAYERＡ性交保存 != -1 && !TCVAR:TARGET:避孕套 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5)
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
	SELECTCASE PLAYER体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_正常位("Ａ正常位_射精")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_后背位("Ａ后背位_射精", 1)
	ENDSELECT
ENDIF

;手淫/手淫する #フェラチオ/フェラす #手淫フェラ*2021/10/11新增*
IF GETBIT(TCVAR:50,3) && (TEQUIP:TARGET:指接触部位 == 1 || TEQUIP:TARGET:Ｐ接触部位 == 3)
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		CALL PRINT_IMAGE_ANIMATION_手淫("手淫_射精" )
ELSEIF GETBIT(TCVAR:50,4) && (TEQUIP:TARGET:口接触部位 == 1 || TEQUIP:TARGET:Ｐ接触部位 == 4)
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF RAND:2 == 0
			CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_射精" )
		ELSE
			CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_射精" )
		ENDIF
ELSEIF (GETBIT(TCVAR:50,3) || GETBIT(TCVAR:50,4)) && ((TEQUIP:TARGET:指接触部位 == 1 && TEQUIP:TARGET:口２ == 1) || (TEQUIP:TARGET:口接触部位 == 1 && TEQUIP:TARGET:指２ == 1))
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_射精" )
ENDIF

;手淫/手淫する #フェラチオ/フェラす*2021/10/11新增*
IF NOWEX:TARGET:射精 > 0 && TEQUIP:TARGET:Ｐ接触部位 == 3
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		CALL PRINT_IMAGE_ANIMATION_手淫("手淫_射精" )
ELSEIF NOWEX:TARGET:射精 > 0 && TEQUIP:TARGET:Ｐ接触部位 == 4
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		CALL PRINT_IMAGE_ANIMATION_フェラ("フェラ_射精" )
ELSEIF NOWEX:TARGET:射精 > 0 && ((TEQUIP:TARGET:指接触部位 == 1 && TEQUIP:TARGET:口２ == 1) || (TEQUIP:TARGET:口接触部位 == 1 && TEQUIP:TARGET:指２ == 1))
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		CALL PRINT_IMAGE_ANIMATION_手淫フェラ("手淫フェラ_射精" )
ENDIF

;足コキ/足コキする*2021/10/29新增*
IF GETBIT(TCVAR:50,7) && TEQUIP:TARGET:足接触部位 == 1
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF RAND:2 == 0
			CALL PRINT_IMAGE_ANIMATION_足コキ("足コキ_射精" )
		ELSE
			CALL PRINT_IMAGE_ANIMATION_足コキ2("足コキ2_射精" )
		ENDIF
ELSEIF NOWEX:TARGET:射精 > 0 && TEQUIP:TARGET:Ｐ接触部位 == 8
	SIF FLAG:画像表示 && FLAG:插绘表示
		PRINTL
		IF RAND:2 == 0
			CALL PRINT_IMAGE_ANIMATION_足コキ("足コキ_射精" )
		ELSE
			CALL PRINT_IMAGE_ANIMATION_足コキ2("足コキ2_射精" )
		ENDIF
ENDIF
;-------------------------------------------------
;调教后の口上
;-------------------------------------------------
;DEBUG	CALL KOJO_MESSAGE_PALAMCNG_C
CALL KOJO_MESSAGE_SEND("PALAM",3,TARGET,-1,-1)
;-------------------------------------------------
;パラメータ变动による口上
;-------------------------------------------------
;DEBUG	CALL KOJO_MESSAGE_PALAMCNG_D
CALL KOJO_MESSAGE_SEND("PALAM",4,TARGET,-1,-1)
;-------------------------------------------------
;刻印取得のチェック(恶作剧中は禁止)
;-------------------------------------------------
IF !CFLAG:TARGET:恶作剧
	CALL MARK_GOT_CHECK(TARGET)
;-------------------------------------------------
;刻印取得による口上(恶作剧中は禁止)
;-------------------------------------------------
;DEBUG	CALL KOJO_MESSAGE_MARKCNG
	CALL KOJO_MESSAGE_SEND("MARK",-1,TARGET,-1,-1)
;-------------------------------------------------
;喷乳メッセージ
;-------------------------------------------------
SIF NOWEX:TARGET:喷乳
	CALL TARGET_MILK_MESSAGE(TARGET)
SIF NOWEX:MASTER:喷乳
	CALL TARGET_MILK_MESSAGE(MASTER)
;-------------------------------------------------
;顺从上升による[抵抗]の消灭チェック(恶作剧中は禁止)
;-------------------------------------------------
	CALL JUJUN_UP_CHECK
ENDIF
RESETCOLOR
;-------------------------------------------------
;调教ソースの表示
;-------------------------------------------------
CALL SHOW_SOURCE
;-------------------------------------------------
;数值变动の表示
;-------------------------------------------------
SETCOLOR C_YELLOW
;相性
R = NO:PLAYER
SIF RELATION:R != 0
	PRINTFORML ＜相性{RELATION:R/100}.{RELATION:R%100}倍＞

SIF TCVAR:TARGET:随便
	PRINTFORML ＜被玩弄中＞

SIF SELECTCOM == 21
	PRINTFORML ＜因【什么也不做】的效果%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的快入手量增加＞
SIF SELECTCOM == 22
	PRINTFORML ＜因【承受诱惑】的效果优越增加＞

SIF TCVAR:指令Ｃ补正 && SOURCE:快Ｃ
	PRINTFORML ＜因指令补正的快Ｃ{ABS(TCVAR:指令Ｃ补正)}％\@ TCVAR:指令Ｃ补正 > 0 ? UP# DOWN\@＞
SIF TCVAR:指令Ｂ补正 && SOURCE:快Ｂ
	PRINTFORML ＜因指令补正的快Ｂ{ABS(TCVAR:指令Ｂ补正)}％\@ TCVAR:指令Ｂ补正 > 0 ? UP# DOWN\@＞
SIF TCVAR:指令Ｖ补正 && SOURCE:快Ｖ
	PRINTFORML ＜因指令补正的快Ｖ{ABS(TCVAR:指令Ｖ补正)}％\@ TCVAR:指令Ｖ补正 > 0 ? UP# DOWN\@＞
SIF TCVAR:指令Ａ补正 && SOURCE:快Ａ
	PRINTFORML ＜因指令补正的快Ａ{ABS(TCVAR:指令Ａ补正)}％\@ TCVAR:指令Ａ补正 > 0 ? UP# DOWN\@＞
SIF TCVAR:指令Ｍ补正 && SOURCE:快Ｍ
	PRINTFORML ＜因指令补正的快Ｍ{ABS(TCVAR:指令Ｍ补正)}％\@ TCVAR:指令Ｍ补正 > 0 ? UP# DOWN\@＞
SIF SELECTCOM == PREVCOM && TFLAG:50 == TFLAG:151 && (SELECTCOM < 350 || SELECTCOM >= 500) && 连续实行()
	PRINTL ＜同一指令连续实行＞
;气力０
SIF BASE:1 <= 0
	PRINTL ★气力０★
RESETCOLOR
LOCAL:1 = 0
FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:当前位置 == SUKIMA()
		CONTINUE
	IF DOWNBASE:LOCAL:体力
		IF DOWNBASE:LOCAL:体力 > 0
			SETCOLOR C_YELLOW
			SIF DOWNBASE:LOCAL:体力 > 150
				SETCOLOR C_RED
			PRINTFORM 体力-{DOWNBASE:LOCAL:体力} 
		ELSE
			SETCOLOR C_GREEN
			PRINTFORM 体力+{-DOWNBASE:LOCAL:体力}
		ENDIF
		LOCAL:1 ++
	ENDIF
	IF DOWNBASE:LOCAL:气力
		IF DOWNBASE:LOCAL:气力 > 0
			SETCOLOR C_YELLOW
			SIF DOWNBASE:LOCAL:气力 > 150
				SETCOLOR C_RED
			PRINTFORM 气力-{DOWNBASE:LOCAL:气力} 
		ELSE
			SETCOLOR C_GREEN
			PRINTFORM 气力+{-DOWNBASE:LOCAL:气力}
		ENDIF
		LOCAL:1 ++
	ENDIF
	RESETCOLOR
	SIF LOCAL:1
		PRINTFORML (%NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%)
	LOCAL:1 = 0
NEXT
SIF TIME_PROGRESS(TIME:1) > 0 && SELECTCOM != 400 && SELECTCOM != 402 && SELECTCOM != 604 && !CFLAG:MASTER:诶嘿嘿
	PRINTFORML +{TIME_PROGRESS(TIME:1)}分
SIF TIME_PROGRESS(TIME:1) >= 40
	TCVAR:TARGET:保持不动 = 1
PRINTL 

;-------------------------------------------------
;パラメータの上升＆表示（DOWNもここで）
;-------------------------------------------------
VARSET LOCAL
FOR LOCAL:1,0,CHARANUM
	SIF TCVAR:缩略显示
		CONTINUE
	LOCAL:3 = 0
	FOR LOCAL,0,100
		SIF PALAMNAME:LOCAL == ""
			CONTINUE
		SIF CUP:(LOCAL:1):LOCAL - CDOWN:(LOCAL:1):LOCAL == 0
			CONTINUE
		IF !LOCAL:3 && CFLAG:(LOCAL:1):当前位置 == CFLAG:MASTER:当前位置
			PRINTL
			PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", (LOCAL:1))%
		ENDIF
		LOCAL:3 ++
		LOCAL:2 = CUP:(LOCAL:1):LOCAL - CDOWN:(LOCAL:1):LOCAL
		SIF CFLAG:(LOCAL:1):当前位置 == CFLAG:MASTER:当前位置
			PRINTFORML %PALAMNAME:LOCAL,8,LEFT% {PALAM:(LOCAL:1):LOCAL,10,LEFT} + {CUP:(LOCAL:1):LOCAL,10,LEFT} =   {PALAM:(LOCAL:1):LOCAL + CUP:(LOCAL:1):LOCAL,10,LEFT}
		PALAM:(LOCAL:1):LOCAL += CUP:(LOCAL:1):LOCAL - CDOWN:(LOCAL:1):LOCAL
		CUP:(LOCAL:1):LOCAL = 0
		CDOWN:(LOCAL:1):LOCAL = 0
	NEXT
NEXT
PRINTL

IF GETBIT(TCVAR:50,1) && TEQUIP:Ｖ性交 != -1 && !TCVAR:PLAYER:避孕套 && GROUPMATCH(体位保存,1,2,3,4,5)
	SELECTCASE 体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_射精后("正常位_中出し")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_射精后("后背位_中出し")
	ENDSELECT
	IF FLAG:画像表示 && FLAG:插绘表示
		WAIT
		PRINTL
	ENDIF
ENDIF

IF NOWEX:TARGET:射精 > 0 && PLAYERＶ性交保存 != -1 && !TCVAR:TARGET:避孕套 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5)
	SELECTCASE PLAYER体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_射精后("正常位_中出し")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_射精后("后背位_中出し", 1)
	ENDSELECT
	IF FLAG:画像表示 && FLAG:插绘表示
		WAIT
		PRINTL
	ENDIF
ENDIF

IF GETBIT(TCVAR:50,2) && TEQUIP:Ａ性交 != -1 && !TCVAR:PLAYER:避孕套 && GROUPMATCH(体位保存,1,2,3,4,5)
	SELECTCASE 体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_射精后("Ａ正常位_中出し")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_射精后("Ａ后背位_中出し")
	ENDSELECT
	IF FLAG:画像表示 && FLAG:插绘表示
		WAIT
		PRINTL
	ENDIF
ENDIF

IF NOWEX:TARGET:射精 > 0 && PLAYERＡ性交保存 != -1 && !TCVAR:TARGET:避孕套 && GROUPMATCH(PLAYER体位保存,1,2,3,4,5)
	SELECTCASE PLAYER体位保存
		CASE 1,3,4
			CALL PRINT_IMAGE_ANIMATION_射精后("Ａ正常位_中出し")
		CASE 2,5
			CALL PRINT_IMAGE_ANIMATION_射精后("Ａ后背位_中出し", 1)
	ENDSELECT
	IF FLAG:画像表示 && FLAG:插绘表示
		WAIT
		PRINTL
	ENDIF
ENDIF

DRAWLINE
;-------------------------------------------------
;欲求不满度上升
;-------------------------------------------------
IF TCVAR:TARGET:欲求不满度管理 < GETPALAMLV(PALAM:情欲,15) && TARGET
	欲求不满度上升 = (GETPALAMLV(PALAM:情欲,15) - TCVAR:TARGET:欲求不满度管理) * 30
	IF TCVAR:TARGET:媚药
		欲求不满度上升 = 欲求不满度上升 * (30 + TCVAR:TARGET:发情 * 20 + TCVAR:TARGET:媚药 * 20) / 30
	ELSEIF TCVAR:TARGET:发情 || TFLAG:仙香玉兔
		欲求不满度上升 = 欲求不满度上升 * (30 + TCVAR:TARGET:发情 * 20 + TFLAG:仙香玉兔 * 10) / 30
	ELSEIF FLAG:甲斐性无
		;なかなか手を出さない相手を见るとやきもきするよね
		欲求不满度上升 = 欲求不满度上升 * MAX((1000 - CFLAG:TARGET:积攒度) / 5 - 110, 30) / 30
	ENDIF
	SIF TALENT:TARGET:路人 == 1
		欲求不满度上升 *= 3
	欲求不满度上升 = 欲求不满素質补正(TARGET, 欲求不满度上升)
	CFLAG:TARGET:积攒度 = LIMIT(欲求不满度上升 + CFLAG:TARGET:积攒度, 0, 1000)
	TCVAR:TARGET:欲求不满度管理 = GETPALAMLV(PALAM:情欲,15)
ENDIF
;-------------------------------------------------
;好感度上升
;-------------------------------------------------
CALL FAVOR_CALC(TARGET)

;-------------------------------------------------
;信赖度上升（ウフフ以外＆上升对象指令实行时）
;-------------------------------------------------
SIF (TFLAG:98 && !CFLAG:TARGET:诶嘿嘿) && !CFLAG:TARGET:睡眠
	CALL TRUST_CALC(TARGET)

;-------------------------------------------------
;泡澡堂タイムUP处理
;-------------------------------------------------
SIF TFLAG:泡澡堂 && (DAY * 1440 + TIME >= TFLAG:泡澡堂)
	CALL 泡澡堂结束判定("タイムUP")

;-------------------------------------------------
;潜伏率の增减处理
;-------------------------------------------------
SIF GETBIT(FLAG:潜伏,0)
	CALL 潜伏率增减处理
	
;-------------------------------------------------
;睡眠深度0による觉醒处理
;-------------------------------------------------
FOR LOCAL,1,CHARANUM
	SIF CFLAG:LOCAL:恶作剧 == 2 && (TCVAR:LOCAL:睡眠深度 <= 0 || !睡眠时间(LOCAL))
		CALL 睡眠奸发觉(LOCAL)
NEXT

;-------------------------------------------------
;抱住模式の解除
;-------------------------------------------------
IF TFLAG:102 == 3 && TFLAG:抱住模式
	TFLAG:抱きつき解放ポイント --
	IF TFLAG:抱きつき解放ポイント <= 0
		PRINTFORML %CALLNAME%满足的离开了%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的身体…
		CALL 被逆推结束
		TFLAG:抱住模式 = 0
		TCVAR:抱きつき禁止时间 = 90 + MAX(10 - ABL:欲望, 0) * 3 - MAX((CFLAG:积极性 + CFLAG:害羞) * 5, 30)
	ENDIF
ENDIF

IF SOURCE:TARGET:魔力印记 == 1
	SOURCE:TARGET:魔力印记 = 0
	PRINTL 魔力印记的效果结束了
ENDIF

;-------------------------------------------------
;变量のリセット
;-------------------------------------------------
CVARSET TCVAR, GETNUM(TCVAR, "侍奉FLAG"), 0
CVARSET TCVAR, GETNUM(TCVAR, "射精槽增加量"), 0
CVARSET TCVAR, GETNUM(TCVAR, "烂醉奸バレ"), 0
CVARSET TCVAR, GETNUM(TCVAR, "料理评价值"), 0
;-------------------------------------------------
;调教ソースの表示（DOWNもここで）
;-------------------------------------------------
@SHOW_SOURCE
SIF TCVAR:缩略显示
	RETURN 0
;PRINTL 　
SIF SOURCE:快Ｃ > 0
	PRINTFORM 快Ｃ({SOURCE:快Ｃ})
SIF SOURCE:快Ｖ > 0
	PRINTFORM 快Ｖ({SOURCE:快Ｖ})
SIF SOURCE:快Ａ > 0
	PRINTFORM 快Ａ({SOURCE:快Ａ})
SIF SOURCE:快Ｂ > 0
	PRINTFORM 快Ｂ({SOURCE:快Ｂ})
SIF SOURCE:快Ｍ > 0
	PRINTFORM 快Ｍ({SOURCE:快Ｍ})
SIF SOURCE:情爱 > 0
	PRINTFORM 情爱({SOURCE:情爱})
SIF SOURCE:性行动 > 0
	PRINTFORM 性行动({SOURCE:性行动})
SIF SOURCE:达成 > 0
	PRINTFORM 达成感({SOURCE:达成})
SIF SOURCE:苦痛 > 0
	PRINTFORM 痛苦({SOURCE:苦痛})
SIF SOURCE:恐怖 > 0
	PRINTFORM 恐怖({SOURCE:恐怖})
SIF SOURCE:液体 > 0
	PRINTFORM 液体({SOURCE:液体})
SIF SOURCE:情欲 > 0
	PRINTFORM 情欲({SOURCE:情欲})
SIF SOURCE:恭顺 > 0
	PRINTFORM 恭顺({SOURCE:恭顺})
SIF SOURCE:露出 > 0
	PRINTFORM 露出({SOURCE:露出})
SIF SOURCE:屈从 > 0
	PRINTFORM 屈服({SOURCE:屈从})
SIF SOURCE:欢乐 > 0
	PRINTFORM 欢乐({SOURCE:欢乐})
SIF SOURCE:征服 > 0
	PRINTFORM 征服({SOURCE:征服})
SIF SOURCE:强迫 > 0
	PRINTFORM 征服({SOURCE:强迫})
SIF SOURCE:被动 > 0
	PRINTFORM 被动({SOURCE:被动})
SIF SOURCE:不洁 > 0
	PRINTFORM 不洁({SOURCE:不洁})
SIF SOURCE:郁闷 > 0
	PRINTFORM 郁闷({SOURCE:郁闷})
SIF SOURCE:偏离正轨 > 0
	PRINTFORM 偏离正轨({SOURCE:偏离正轨})
SIF SOURCE:反感 > 0
	PRINTFORM 反抗({SOURCE:反感})
PRINTL 　

@OAZUKE(ARG)
#FUNCTION
SIF CFLAG:ARG:诶嘿嘿 != 2
	RETURNF 0
SELECTCASE TCVAR:ARG:20
	CASE 41
	;正常位V
		SIF SELECTCOM != 320
			RETURNF 1
	CASE 43
	;バックV
		SIF SELECTCOM != 322
			RETURNF 1
	CASE 44
	;バックA
		SIF SELECTCOM != 323
			RETURNF 1
ENDSELECT
RETURNF 0
