[SKIPSTART]
;日记口上

;一日の结束时の流れ
;@DIARY_TEXT_K38（日记本文）→@DIARY_AFTER_CHECK_K38（フラグの处理）


;◆日记の仕样◆
;※１@DIARY_BEFORE_CHECK_K38で日记のフラグが立つ。
;→未读フラグ(2)が立っていると一日の终わりにデイリーイベントとして日记が读まれる（既读になる）。
;→※２未读フラグ(3)が立っていると[日记を读む]で读む事ができる。读むと既读(1)になる。
;※１各所イベント口上やコマンド口上でフラグを立たせても良いです。
;※２基本的には未读(2)推奖です。既读(1)、未读(3)はワンステップ必要。

;[日记を读む]には、持ち主が[恋慕]なら自由に读むことができ、
;そうでない场合は恋慕でない人物がその场に居ない时、もしくは时间停止することで盗み读みできる。
;据点住民でないキャラは恋慕であれば自宅（招待房间）で读むことができる。

;MAX_DIARY_PAGE:38:0　キャラ番号38的日记の最大ページ数　限度は101（1～100）
;DIARY:38:YY　　　　　キャラ番号38的日记番号YYの情报
;　　 3=未读　　　　　デイリーイベントで读まれない。[日记を读む]で读むと既读になる。
;　　 2=未读　　　　　デイリーイベントで读まれる。读まれるまでは[日记を读む]では读めない。读まれると既读になる。
;　　 1=既读　　　　　デイリーイベントで读まれない。[日记を读む]で读める。
;　　 0=读めない　　　未解禁。
;PAGESET:38:YY　　　　キャラ番号38の实际に书かれたYYページ目的日记番号。
;=============================
@DIARY_NK_K38_EXIST
;存在判定
;0だと日记は书かれません。
;=============================
RETURN 1

;=============================
@DIARY_NK_AFTER_CHECK_K38
;デイリーイベントで日记が读まれた际の后处理。
;フラグの管理等自由に扱って良い。

;条件フラグのリセットや判定追加もここに 
;たとえば：今日构ったフラグ
;今日构った日记が表示した后、构ったフラグをリセット。
; CFLAG:38:今日构ったフラグ = 0
;あるいは何かの状态が续くことがフラグの场合
;例：好感度がほぼ变わらない日が续くと
;「あなた」の态度が冷たいな～みたいな日记を书く
; SIF CFLAG:38:好感度 <= LAST_LP+3
;   NOTOUCH_DAY ++
;=============================


;=============================
@DIARY_NK_BEFORE_CHECK_K38
;常时チェックされる日记の状态情报。
;ここでDIARY:38:YYの更新を行う。
;※DIARY:38:0番は使えません。

;ここで泛用发生条件を记入する
;コマンド别の发生条件はM_KOJOの各ファイル中で追加してください。

;基本的に发生条件には"DIARY:38:YY == 0"を入れること。
;そうしないと同じ日记が书かれたりしてしまう。

;DIARY:38:YY　　　　キャラ番号38的日记番号YYの情报
;　　 3=未读　　　　デイリーイベントで读まれない。[日记を读む]で读むと既读になる。
;　　 2=未读　　　　デイリーイベントで读まれる。读まれるまでは[日记を读む]では读めない。读まれると既读になる。
;　　 1=既读　　　　デイリーイベントで读まれない。[日记を读む]で读める。
;　　 0=读めない　　未解禁。

;○未读(2)にする场合（基本）
;未读(2)にするとデイリーイベントとして发生し、一日の终わりに１つだけ读まれる。
;复数のページが未读(2)になっている场合は番号が小さいものが读まれ、それ以外はリセット(0)される。
;その为、复数同时に发生すると、发生したのに读まれずリセットされる场合もある。
;未读(2)にするには单纯にフラグに2を入れるだけで良い。

;例１)初对面
;SIF DIARY:38:YY == 0 && CFLAG:38:认识
;	DIARY:38:YY = 2

;○未读(3)にする场合（应用）
;未读(3)にするとデイリーイベントとして读まれず、书かれた时点で[日记を读む]によって读めるようになる。
;プレイヤーが自主的に读まない限り读まれず、一日に复数ページ追加される场合もある。
;未读(3)にするにはフラグに3を入れた上で、CALL CHARA_DIARY_PAGESETTING(38, YY)をする必要がある。

;例２）好感度100以上
;IF DIARY:38:YY == 0 && CFLAG:38:好感度 >= 100
;	DIARY:38:YY = 3
;	CALL CHARA_DIARY_PAGESETTING(38, YY)
;ENDIF

;例３）例２的日记が读まれた上で好感度1000以上
;これをするとYYを读んだ直后にZZが书き込まれることも起こる。
;IF DIARY:38:ZZ == 0 && DIARY:38:YY == 1 && CFLAG:38:好感度 >= 1000
;	DIARY:38:ZZ = 3
;	CALL CHARA_DIARY_PAGESETTING(38, ZZ)
;ENDIF

;▽おせっかいな注釈
;初吻は基本的に全员[キス未经验]を所持しているので、"!TALENT:38:无接吻经验"で判定できます。
;デート归りのキスで分岐したいならデート归りのキス口上でフラグを立てます。
;その场合、通常の初吻丧失と重复しないように气をつけましょう。
;处女丧失は初期设定で处女丧失している场合もあるので、处女丧失口上の方でフラグを立てた方が良いです。
;その他告白・陷落等のイベントは各种イベント口上でフラグを立てます。初对面はそっちでも大丈夫です。
;日期を正确に测るには别途フラグが必要です。例えば初めて会った日とか。
;=============================
;MAXPAGEはここで记入する
MAX_DIARY_PAGE:38:0 = 1

;=============================
@DIARY_NK_TEXT_K38, PAGENUM, MODE, PAGECOUNT
;日记の内容
;PAGENUM   = 日记番号（日记のパターン）
;MODE      = "デイリー":一日结束时のデイリーイベントでの读み上げ
;          = "コマンド":[日记を读む]コマンドでの读み上げ
;PAGECOUNT = 何ページ目に书かれているか
;=============================
#DIM PAGENUM
#DIMS MODE
#DIM PAGECOUNT

;口上色指定あるならコメントアウトを外す
;CALL M_KOJO_COLOR_K38

;グループマッチに日记のIDを入れて、表示させたい颜绘を表示する
;表情・服装・特殊画像をオプション指定で表示（省略可）
;书式は\resources\颜.CSVと下の例を参照

;以下はサンプル
IF MODE == "デイリー"
	IF GROUPMATCH(PAGENUM, 1) 
		CALL PRINT_FACE, 38, "发情", "裸", "_1"
	ELSEIF GROUPMATCH(PAGENUM, 2)
		CALL PRINT_FACE, 38, "笑颜", "服1"
	ELSEIF GROUPMATCH(PAGENUM, 3)
		CALL PRINT_FACE, 38, "愤怒"
	ELSE
		CALL PRINT_FACE, 38
	ENDIF
ENDIF

PRINTFORMDL - %CALLNAME:38%的日记　PAGE.{PAGECOUNT} --------------------------------------------------------------------------------------
PRINTL

;※PAGENUM:0は使えません
SELECTCASE PAGENUM
	CASE 1
		PRINTFORML ○月×日
		PRINTFORML 今日から、日记をつける事にした。
ENDSELECT

RESETCOLOR

;=============================
@M_KOJO_NK_MESSAGE_COM_K38_406
;=============================
CALL M_KOJO_NK_MESSAGE_COM_K38_406_1
RETURN RESULT

;=============================
@M_KOJO_NK_MESSAGE_COM_K38_406_1
;コマンド口上
;TFLAG:不影响SOURCE等的SELECTCOM的分岐（谁的日记を读んでいるか）
;TFLAG:不影响SOURCE等的SELECTCOM的分岐が38でない场合は他人的日记なので注意。
;PAGEは书かれてあるページ数。
;SHIRAHU(38)はキャラ38の状态が正常かどうか。
;=============================
#DIM PAGE

;以下はサンプル
PAGE = 0
FOR LOCAL, 0, MAX_DIARY_PAGE:(TFLAG:不影响SOURCE等的SELECTCOM的分岐):0
	IF GROUPMATCH(DIARY:(TFLAG:不影响SOURCE等的SELECTCOM的分岐):LOCAL, 1, 3)
		PAGE ++
	ENDIF
NEXT

IF SHIRAHU(38) && TFLAG:不影响SOURCE等的SELECTCOM的分岐 == 38
;日记を读み终わった后の反应
	IF PAGE > 2
		CALL SPTALK, 38,"通常",0,@"「日记を见せるって…なんだか耻ずかしいな…」//%CALLNAME:38%はまじまじとこちらを见つめている"
		;画像つきトークは最大６行まで。
	ELSE
		PRINTFORML 
	ENDIF
ENDIF
[SKIPEND]