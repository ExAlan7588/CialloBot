# 更新日誌 - 刪除關鍵詞回覆功能

## 版本 1.1.0 - 2025-12-07

### 🆕 新增功能

#### 右鍵刪除關鍵詞回覆訊息

用戶現在可以通過右鍵點擊機器人的關鍵詞回覆訊息來刪除它。

**功能特點：**
- ✅ 右鍵菜單：在機器人的回覆訊息上右鍵，選擇「刪除此回覆」
- ✅ 權限控制：只有觸發關鍵詞的用戶或管理員可以刪除
- ✅ 確認對話框：提供「確認刪除」和「取消」按鈕，防止誤操作
- ✅ 安全保護：30 秒超時自動失效，只有發起者可以確認
- ✅ 保留配置：刪除訊息不影響關鍵詞配置，下次仍會觸發

**使用方式：**
1. 發送關鍵詞觸發機器人回覆
2. 右鍵點擊機器人的回覆訊息
3. 選擇「刪除此回覆」
4. 點擊「確認刪除」

### 🔧 技術改進

#### 1. 訊息回覆方式改進
- **變更前：** 使用 `channel.send()` 發送回覆
- **變更後：** 使用 `message.reply()` 發送回覆
- **優點：** 可以追溯到觸發者，支援權限驗證

#### 2. 新增 Message Context Menu
- 添加全局 Context Menu：「刪除此回覆」
- 在 Cog 初始化時註冊，卸載時自動移除

#### 3. 新增確認視圖（DeleteConfirmView）
- 使用 Discord UI 組件實現確認對話框
- 包含「確認刪除」和「取消」按鈕
- 30 秒超時保護
- 只有發起者可以操作

#### 4. 權限驗證邏輯
```python
# 檢查權限：觸發者或管理員
is_original_author = interaction.user.id == original_message.author.id
is_admin = self.is_admin(interaction)

if not is_original_author and not is_admin:
    # 拒絕訪問
```

### 📝 文件更新

- ✅ 更新 `KEYWORD_SYSTEM.md`：添加新功能說明
- ✅ 新增 `TESTING_DELETE_FEATURE.md`：完整測試指南
- ✅ 新增 `CHANGELOG_DELETE_FEATURE.md`：更新日誌

### 🔍 代碼變更摘要

**修改文件：**
- `cogs/keyword_cog.py`

**新增類別：**
- `DeleteConfirmView`：刪除確認視圖

**新增方法：**
- `delete_keyword_response()`：Context Menu 回調函數
- `cog_unload()`：Cog 卸載清理

**修改方法：**
- `__init__()`：添加 Context Menu 註冊
- `on_message()`：改用 `reply()` 而非 `send()`

### ⚠️ 重要提醒

1. **需要重新同步命令**
   - 重啟機器人後，Context Menu 會自動同步
   - Discord 全局同步可能需要 1 小時生效

2. **機器人權限要求**
   - 需要「管理訊息」權限才能刪除訊息
   - 如果沒有權限，會顯示錯誤訊息

3. **向後兼容性**
   - 舊的關鍵詞回覆（使用 `send`）無法使用刪除功能
   - 需要重新觸發關鍵詞才能使用新功能

### 🐛 已知限制

1. **Context Menu 全局可見**
   - 所有用戶都能看到「刪除此回覆」選項
   - 權限檢查在執行時進行

2. **只能刪除 reply 類型的訊息**
   - 必須是使用 `reply()` 發送的訊息
   - 無法追溯舊的 `send()` 訊息的觸發者

### 📊 測試狀態

請參考 `TESTING_DELETE_FEATURE.md` 進行完整測試。

**測試檢查清單：**
- [ ] 觸發者可以刪除自己觸發的回覆
- [ ] 管理員可以刪除任何回覆
- [ ] 非權限用戶無法刪除
- [ ] 確認對話框正常工作
- [ ] 取消操作正常工作
- [ ] 超時保護正常工作
- [ ] 錯誤處理正確
- [ ] 關鍵詞配置未受影響

---

**發布日期：** 2025-12-07  
**開發者：** Kiro AI Assistant  
**版本：** 1.1.0
