# 測試「刪除關鍵詞回覆」功能

## 📋 功能概述

新增功能：用戶可以通過右鍵點擊機器人的關鍵詞回覆訊息來刪除它。

## 🎯 測試步驟

### 前置準備

1. **啟動機器人**
   ```bash
   python bot.py
   ```

2. **確認機器人已上線**
   - 檢查 Discord 伺服器中機器人狀態為「在線」
   - 查看日誌確認 Context Menu 已註冊
   - 查看日誌確認 CopypastaCog 已載入

3. **設定測試關鍵詞**（需要管理員權限）
   ```
   /keyword add
   關鍵詞: 測試
   回覆內容: 這是一個測試回覆！
   ```

4. **確認 copypasta 數據存在**
   - 檢查 `copypastas.json` 文件存在且有內容

### 測試案例 1：觸發者刪除自己觸發的回覆

**步驟：**
1. 在頻道中發送：`測試`
2. 機器人應該回覆：`這是一個測試回覆！`（使用 reply 功能）
3. 右鍵點擊機器人的回覆訊息
4. 選擇「刪除此回覆」選項
5. 應該看到確認對話框，顯示：
   - 原始訊息內容
   - 回覆內容
   - 兩個按鈕：「確認刪除」和「取消」
6. 點擊「確認刪除」
7. 機器人的回覆訊息應該被刪除
8. 收到確認訊息：「✅ 已成功刪除回覆訊息！」

**預期結果：**
- ✅ 訊息成功刪除
- ✅ 關鍵詞配置未受影響（再次發送「測試」仍會觸發回覆）

### 測試案例 2：管理員刪除其他用戶觸發的回覆

**步驟：**
1. 用戶 A 發送：`測試`
2. 機器人回覆
3. 管理員（用戶 B）右鍵點擊機器人的回覆
4. 選擇「刪除此回覆」
5. 點擊「確認刪除」

**預期結果：**
- ✅ 管理員可以成功刪除
- ✅ 訊息被刪除

### 測試案例 3：非觸發者且非管理員嘗試刪除

**步驟：**
1. 用戶 A 發送：`測試`
2. 機器人回覆
3. 用戶 C（非管理員，非觸發者）右鍵點擊機器人的回覆
4. 選擇「刪除此回覆」

**預期結果：**
- ✅ 收到錯誤訊息：「❌ 只有觸發此關鍵詞的用戶或管理員才能刪除此回覆！」
- ✅ 訊息未被刪除

### 測試案例 4：取消刪除操作

**步驟：**
1. 發送：`測試`
2. 機器人回覆
3. 右鍵點擊機器人的回覆
4. 選擇「刪除此回覆」
5. 點擊「取消」按鈕

**預期結果：**
- ✅ 收到訊息：「✅ 已取消刪除操作。」
- ✅ 訊息未被刪除

### 測試案例 5：對非關鍵詞回覆使用刪除功能

**步驟：**
1. 使用任何其他命令（如 `/keyword list`）
2. 右鍵點擊機器人的回覆
3. 選擇「刪除此回覆」

**預期結果：**
- ✅ 收到錯誤訊息：「❌ 此訊息不是關鍵詞觸發的回覆！」

### 測試案例 6：對其他用戶的訊息使用刪除功能

**步驟：**
1. 右鍵點擊任何用戶（非機器人）的訊息
2. 選擇「刪除此回覆」

**預期結果：**
- ✅ 收到錯誤訊息：「❌ 此功能只能用於刪除機器人的回覆訊息！」

### 測試案例 7：確認對話框超時

**步驟：**
1. 發送：`測試`
2. 機器人回覆
3. 右鍵點擊機器人的回覆
4. 選擇「刪除此回覆」
5. 等待 30 秒不點擊任何按鈕

**預期結果：**
- ✅ 按鈕變為禁用狀態
- ✅ 訊息未被刪除

### 測試案例 8：其他用戶嘗試點擊確認按鈕

**步驟：**
1. 用戶 A 發送：`測試`
2. 用戶 A 右鍵點擊機器人的回覆，選擇「刪除此回覆」
3. 用戶 B 嘗試點擊用戶 A 的確認對話框中的按鈕

**預期結果：**
- ✅ 用戶 B 收到錯誤訊息：「❌ 只有發起刪除請求的用戶才能確認！」

## 🔍 檢查點

### 日誌檢查

查看 `logs/bot.log`，應該看到：

```
✅ KeywordCog 已載入
🔑 觸發關鍵詞 '測試' 在伺服器 XXX (123456789)
🗑️ 用戶 XXX 刪除了關鍵詞回覆訊息 (ID: 123456789)
```

### 關鍵詞配置檢查

查看 `server_keywords.json`，確認：
- 刪除訊息後，關鍵詞仍然存在
- 可以再次觸發相同的關鍵詞

## ⚠️ 已知限制

1. **Context Menu 全局可見**
   - 所有用戶都能看到「刪除此回覆」選項
   - 權限檢查在執行時進行，而非顯示時

2. **只能刪除使用 reply 功能的回覆**
   - 舊的關鍵詞回覆（使用 `send` 而非 `reply`）無法追溯觸發者
   - 需要重新觸發關鍵詞才能使用新功能

3. **機器人權限要求**
   - 機器人需要「管理訊息」權限才能刪除訊息
   - 如果沒有權限，會顯示錯誤訊息

## 🐛 故障排除

### 問題：右鍵菜單中沒有「刪除此回覆」選項

**可能原因：**
- Context Menu 未同步到 Discord

**解決方案：**
1. 重啟機器人
2. 等待 Discord 同步（可能需要 1 小時）
3. 檢查日誌確認 Context Menu 已註冊

### 問題：點擊「確認刪除」後訊息未被刪除

**可能原因：**
- 機器人沒有「管理訊息」權限

**解決方案：**
1. 檢查機器人角色權限
2. 確保機器人有「管理訊息」權限
3. 查看日誌中的錯誤訊息

### 問題：無法刪除舊的關鍵詞回覆

**原因：**
- 舊的回覆使用 `send` 而非 `reply`，無法追溯觸發者

**解決方案：**
- 重新觸發關鍵詞，新的回覆將使用 `reply` 功能

## 📊 測試結果記錄

| 測試案例 | 狀態 | 備註 |
|---------|------|------|
| 案例 1：觸發者刪除 | ⬜ 未測試 | |
| 案例 2：管理員刪除 | ⬜ 未測試 | |
| 案例 3：無權限用戶 | ⬜ 未測試 | |
| 案例 4：取消刪除 | ⬜ 未測試 | |
| 案例 5：非關鍵詞回覆 | ⬜ 未測試 | |
| 案例 6：其他用戶訊息 | ⬜ 未測試 | |
| 案例 7：對話框超時 | ⬜ 未測試 | |
| 案例 8：其他用戶點擊 | ⬜ 未測試 | |

## 🆕 Copypasta 刪除功能測試

### 測試案例 9：Copypasta 刪除按鈕 - 觸發者刪除

**步驟：**
1. 使用 `/copypasta` 指令
2. 機器人應該發送一個 copypasta，並在下方顯示「🗑️ 刪除」按鈕
3. 點擊「刪除」按鈕
4. 訊息應該被刪除
5. 收到確認訊息：「✅ 已成功刪除訊息！」

**預期結果：**
- ✅ 按鈕顯示正常
- ✅ 訊息成功刪除
- ✅ 確認訊息顯示

### 測試案例 10：Copypasta 刪除按鈕 - 管理員刪除

**步驟：**
1. 用戶 A 使用 `/copypasta` 指令
2. 管理員（用戶 B）點擊「刪除」按鈕

**預期結果：**
- ✅ 管理員可以成功刪除
- ✅ 訊息被刪除

### 測試案例 11：Copypasta 刪除按鈕 - 無權限用戶

**步驟：**
1. 用戶 A 使用 `/copypasta` 指令
2. 用戶 C（非管理員，非觸發者）點擊「刪除」按鈕

**預期結果：**
- ✅ 收到錯誤訊息：「❌ 只有觸發此指令的用戶或管理員才能刪除此訊息！」
- ✅ 訊息未被刪除

### 測試案例 12：Copypasta 刪除按鈕 - 超時測試

**步驟：**
1. 使用 `/copypasta` 指令
2. 等待 5 分鐘不點擊按鈕

**預期結果：**
- ✅ 按鈕變為禁用狀態（灰色）
- ✅ 訊息未被刪除

## ✅ 測試完成標準

### Keyword 功能
- [ ] 所有 Keyword 測試案例通過
- [ ] 日誌記錄正確
- [ ] 關鍵詞配置未受影響
- [ ] 權限控制正常工作
- [ ] 確認對話框功能正常
- [ ] 錯誤處理正確

### Copypasta 功能
- [ ] 所有 Copypasta 測試案例通過
- [ ] 刪除按鈕顯示正常
- [ ] 權限控制正常工作
- [ ] 超時機制正常
- [ ] 錯誤處理正確
- [ ] 日誌記錄正確

---

**測試日期：** _____________  
**測試人員：** _____________  
**機器人版本：** _____________
